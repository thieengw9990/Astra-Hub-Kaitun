local Rayfield = loadstring(game:HttpGet("https://raw.githubusercontent.com/shlexware/Rayfield/main/source.lua"))()
local VirtualInputManager = game:GetService("VirtualInputManager")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local TeleportService = game:GetService("TeleportService")
local Lighting = game:GetService("Lighting")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

-- Config setting
local Config = {
    AutoFarm = false,
    AutoFarmLevel = false,
    AutoNewWorld = false,
    AutoThirdSea = false,
    AutoSaber = false,
    AutoPole = false,
    AutoBuyEnchantment = false,
    AutoBartilo = false,
    AutoRengoku = false,
    AutoFarmBone = false,
    AutoCakePrince = false,
    AutoFarmEctoplasm = false,
    AutoBuyLegendarySword = false,
    AutoTwinHooks = false,
    AutoOpenSwanDoor = false,
    AutoKen = false,
    AutoHallowSycthe = false,
    AutoFarmMysticDroplet = false,
    AutoEvoRace = false,
    AutoBartiloQuest = false,
    AutoHakiColor = false,
    AutoDarkbeard = false,
    AutoCursedCaptain = false,
    AutoSoulGuitar = false,
    AutoTerrorshark = false,
    AutoSharkMan = false,
    AutoPirateRaid = false,
    AutoBuyGhoul = false,
    AutoFactory = false,
    AutoSuperhuman = false,
    AutoDeathStep = false,
    AutoElectricClaw = false,
    AutoGodHuman = false,
    AutoDragonTalon = false,
    AutoLeviathan = false,
    AutoFarmSeaBeast = false,
    AutoKillSeaBeast = false,
    AutoFarmShip = false,
    AutoFarmChest = false,
    AutoChestHop = false,
    AutoRandomBone = false,
    AutoCollectAura = false,
    AutoTushita = false,
    AutoYama = false,
    AutoRipIndra = false,
    AutoHolyTorch = false,
    AutoFarmElite = false,
    AutoFarmBoss = false,
    SelectedBoss = "",
    AutoFarmQuest = false,
    SelectedQuest = "",
    AutoMelee = false,
    AutoDefense = false,
    AutoSword = false,
    AutoGun = false,
    AutoFruit = false,
    BringNPC = false,
    FastAttack = true,
    SuperFastAttack = false,
    AutoHaki = true,
    AutoBuso = true,
    AutoObservation = false,
    AutoKenV2 = false,
    AutoGeppo = false,
    AutoSoru = false,
    AutoFarmAllBoss = false,
    AutoSellAllFruit = false,
    AutoStoreAllFruit = false,
    AutoRedeemAllCode = false,
    HopLowerServer = false,
    AutoCollectChest = false,
    AutoKillPlayer = false,
    AutoKillPlayerGun = false,
    AutoKillPlayerMelee = false,
    AutoKillPlayerSword = false,
    SelectedWeapon = "Melee",
    Magnet = true,
    MagnetDistance = 500,
    BringFruit = false,
    AutoRandomFruit = false,
    AutoBuyFruit = false,
    AutoDropFruit = false,
    AutoFarmGunMastery = false,
    AutoFarmSwordMastery = false,
    SkipCutscene = true,
    DisableDamageAnimation = false,
    RemoveEffect = false,
    WhiteScreen = false,
    AntiAFK = true,
    ShowHitbox = false,
    AimbotSkill = false,
    WalkOnWater = false,
    NoClip = false,
    Fly = false,
    FlySpeed = 50,
    WalkSpeed = 50,
    JumpPower = 50,
    InfEnergy = false,
    AutoClick = false,
    AutoClickSpeed = 1,
    BringChest = false,
    AutoFarmMaterial = false,
    SelectedMaterial = "",
    AutoFarmMastery = false,
    SelectedMasteryWeapon = "",
    AutoFarmFruitMastery = false,
    SelectedFruitMastery = "",
    AutoFarmBeli = false,
    AutoFarmFragment = false,
    AutoFarmCandy = false,
    AutoFarmCoreBrain = false,
    AutoFarmBossAll = false,
    AutoFarmBossSelected = "",
    AutoFarmSpawnBoss = false,
    AutoFarmChestAll = false,
    AutoFarmChestSelected = "",
    AutoFarmIsland = false,
    SelectedIsland = "",
    AutoFarmShipAll = false,
    AutoFarmShipSelected = "",
    AutoFarmSeaEvent = false,
    SelectedSeaEvent = "",
    AutoFarmTrial = false,
    SelectedTrial = "",
    AutoFarmRaid = false,
    SelectedRaid = "",
    AutoFarmSecret = false,
    SelectedSecret = "",
    AutoFarmHakiColor = false,
    SelectedHakiColor = "",
    AutoFarmRace = false,
    SelectedRace = "",
    AutoFarmQuestAll = false,
    AutoFarmQuestSelected = "",
    AutoFarmDungeon = false,
    SelectedDungeon = "",
    AutoFarmFactory = false,
    AutoFarmCursedShip = false,
    AutoFarmGhostShip = false,
    AutoFarmFlameShip = false,
    AutoFPSBoost = false,
    AutoGraphics = false,
    AutoRejoin = false,
    AutoHop = false,
    HopAfterTime = 300,
    HopWhenPlayer = 10,
    HopWhenNoPlayer = false,
    AutoSaveSetting = false,
    LoadSetting = false,
    SettingName = "Default",
    AutoPriority = false,
    Webhook = false,
    WebhookUrl = "",
    DiscordId = "",
    AutoSendStats = false,
    SendStatsInterval = 60,
    AutoNotify = false,
    NotifyWhenDone = false,
    NotifyWhenError = false,
    NotifyWhenHop = false,
    NotifyWhenBoss = false,
    NotifyWhenChest = false,
    NotifyWhenSeaBeast = false,
    NotifyWhenShip = false,
    NotifyWhenRaid = false,
    NotifyWhenSecret = false,
    NotifyWhenHaki = false,
    NotifyWhenRace = false,
    NotifyWhenQuest = false,
    NotifyWhenDungeon = false,
    NotifyWhenFactory = false,
    NotifyWhenCursedShip = false,
    NotifyWhenGhostShip = false,
    NotifyWhenFlameShip = false,
    NotifyWhenTrial = false,
    NotifyWhenIsland = false,
    NotifyWhenMaterial = false,
    NotifyWhenMastery = false,
    NotifyWhenFruit = false,
    NotifyWhenBeli = false,
    NotifyWhenFragment = false,
    NotifyWhenCandy = false,
    NotifyWhenCoreBrain = false,
    NotifyWhenBossAll = false,
    NotifyWhenChestAll = false,
    NotifyWhenShipAll = false,
    NotifyWhenSeaEvent = false,
    NotifyWhenQuestAll = false,
    NotifyWhenSecretAll = false,
    NotifyWhenHakiAll = false,
    NotifyWhenRaceAll = false,
    NotifyWhenTrialAll = false,
    NotifyWhenIslandAll = false,
    NotifyWhenMaterialAll = false,
    NotifyWhenMasteryAll = false,
    NotifyWhenFruitAll = false,
    NotifyWhenBeliAll = false,
    NotifyWhenFragmentAll = false,
    NotifyWhenCandyAll = false,
    NotifyWhenCoreBrainAll = false
}

-- Tạo Window chính
local Window = Rayfield:CreateWindow({
    Name = "Astra X Hub | Kaitun Levi",
    LoadingTitle = "Astra X Hub loading...",
    LoadingSubtitle = "by _Wt",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "AstraXHub",
        FileName = "KaitunLevi"
    },
    Discord = {
        Enabled = true,
        Invite = "astraxhub",
        RememberJoins = true
    },
    KeySystem = false,
    KeySettings = {
        Title = "Astra X Hub",
        Subtitle = "Key System",
        Note = "Join discord for key",
        FileName = "AstraXHubKey",
        SaveKey = true,
        GrabKeyFromSite = false,
        Key = {"ASTRAXHUB_FREE"}
    }
})

-- Theme Aqua
Rayfield:SetTheme("Aqua")

-- Main Tab
local MainTab = Window:CreateTab("Main", nil)

-- Auto Farm Section
local AutoFarmSection = MainTab:CreateSection("Auto Farm")
local AutoFarmToggle = MainTab:CreateToggle({
    Name = "Auto Farm Level",
    CurrentValue = Config.AutoFarmLevel,
    Flag = "AutoFarmLevel",
    Callback = function(Value)
        Config.AutoFarmLevel = Value
        if Value then
            StartAutoFarmLevel()
        end
    end
})

local AutoFarmBossToggle = MainTab:CreateToggle({
    Name = "Auto Farm Boss",
    CurrentValue = Config.AutoFarmBoss,
    Flag = "AutoFarmBoss",
    Callback = function(Value)
        Config.AutoFarmBoss = Value
        if Value then
            StartAutoFarmBoss()
        end
    end
})

local BossDropdown = MainTab:CreateDropdown({
    Name = "Select Boss",
    Options = {"Sea Beast", "Leviathan", "Shark", "Terrorshark", "Cursed Captain", "Darkbeard", "Soul Reaper"},
    CurrentOption = Config.SelectedBoss,
    Flag = "SelectedBoss",
    Callback = function(Option)
        Config.SelectedBoss = Option
    end
})

local AutoFarmQuestToggle = MainTab:CreateToggle({
    Name = "Auto Farm Quest",
    CurrentValue = Config.AutoFarmQuest,
    Flag = "AutoFarmQuest",
    Callback = function(Value)
        Config.AutoFarmQuest = Value
        if Value then
            StartAutoFarmQuest()
        end
    end
})

local QuestDropdown = MainTab:CreateDropdown({
    Name = "Select Quest",
    Options = {"Bartilo", "Rengoku", "Elite Hunter", "Pirate Raid", "Factory"},
    CurrentOption = Config.SelectedQuest,
    Flag = "SelectedQuest",
    Callback = function(Option)
        Config.SelectedQuest = Option
    end
})

-- Auto Leviathan Section
local LeviathanSection = MainTab:CreateSection("Leviathan")
local AutoLeviathanToggle = MainTab:CreateToggle({
    Name = "Auto Leviathan",
    CurrentValue = Config.AutoLeviathan,
    Flag = "AutoLeviathan",
    Callback = function(Value)
        Config.AutoLeviathan = Value
        if Value then
            StartAutoLeviathan()
        end
    end
})

local AutoKillSeaBeastToggle = MainTab:CreateToggle({
    Name = "Auto Kill Sea Beast",
    CurrentValue = Config.AutoKillSeaBeast,
    Flag = "AutoKillSeaBeast",
    Callback = function(Value)
        Config.AutoKillSeaBeast = Value
        if Value then
            StartAutoKillSeaBeast()
        end
    end
})

local AutoFarmSeaBeastToggle = MainTab:CreateToggle({
    Name = "Auto Farm Sea Beast",
    CurrentValue = Config.AutoFarmSeaBeast,
    Flag = "AutoFarmSeaBeast",
    Callback = function(Value)
        Config.AutoFarmSeaBeast = Value
        if Value then
            StartAutoFarmSeaBeast()
        end
    end
})

-- Auto Item Section
local AutoItemSection = MainTab:CreateSection("Auto Item")
local AutoSaberToggle = MainTab:CreateToggle({
    Name = "Auto Saber",
    CurrentValue = Config.AutoSaber,
    Flag = "AutoSaber",
    Callback = function(Value)
        Config.AutoSaber = Value
        if Value then
            StartAutoSaber()
        end
    end
})

local AutoPoleToggle = MainTab:CreateToggle({
    Name = "Auto Pole",
    CurrentValue = Config.AutoPole,
    Flag = "AutoPole",
    Callback = function(Value)
        Config.AutoPole = Value
        if Value then
            StartAutoPole()
        end
    end
})

local AutoRengokuToggle = MainTab:CreateToggle({
    Name = "Auto Rengoku",
    CurrentValue = Config.AutoRengoku,
    Flag = "AutoRengoku",
    Callback = function(Value)
        Config.AutoRengoku = Value
        if Value then
            StartAutoRengoku()
        end
    end
})

local AutoTwinHooksToggle = MainTab:CreateToggle({
    Name = "Auto Twin Hooks",
    CurrentValue = Config.AutoTwinHooks,
    Flag = "AutoTwinHooks",
    Callback = function(Value)
        Config.AutoTwinHooks = Value
        if Value then
            StartAutoTwinHooks()
        end
    end
})

local AutoKenToggle = MainTab:CreateToggle({
    Name = "Auto Ken",
    CurrentValue = Config.AutoKen,
    Flag = "AutoKen",
    Callback = function(Value)
        Config.AutoKen = Value
        if Value then
            StartAutoKen()
        end
    end
})

-- World Tab
local WorldTab = Window:CreateTab("World", nil)

-- Sea Events Section
local SeaEventsSection = WorldTab:CreateSection("Sea Events")
local AutoFarmShipToggle = WorldTab:CreateToggle({
    Name = "Auto Farm Ship",
    CurrentValue = Config.AutoFarmShip,
    Flag = "AutoFarmShip",
    Callback = function(Value)
        Config.AutoFarmShip = Value
        if Value then
            StartAutoFarmShip()
        end
    end
})

local AutoFarmChestToggle = WorldTab:CreateToggle({
    Name = "Auto Farm Chest",
    CurrentValue = Config.AutoFarmChest,
    Flag = "AutoFarmChest",
    Callback = function(Value)
        Config.AutoFarmChest = Value
        if Value then
            StartAutoFarmChest()
        end
    end
})

local AutoChestHopToggle = WorldTab:CreateToggle({
    Name = "Auto Chest Hop",
    CurrentValue = Config.AutoChestHop,
    Flag = "AutoChestHop",
    Callback = function(Value)
        Config.AutoChestHop = Value
        if Value then
            StartAutoChestHop()
        end
    end
})

local AutoCollectChestToggle = WorldTab:CreateToggle({
    Name = "Auto Collect Chest",
    CurrentValue = Config.AutoCollectChest,
    Flag = "AutoCollectChest",
    Callback = function(Value)
        Config.AutoCollectChest = Value
        if Value then
            StartAutoCollectChest()
        end
    end
})

-- Raid Section
local RaidSection = WorldTab:CreateSection("Raid")
local AutoPirateRaidToggle = WorldTab:CreateToggle({
    Name = "Auto Pirate Raid",
    CurrentValue = Config.AutoPirateRaid,
    Flag = "AutoPirateRaid",
    Callback = function(Value)
        Config.AutoPirateRaid = Value
        if Value then
            StartAutoPirateRaid()
        end
    end
})

local AutoFactoryToggle = WorldTab:CreateToggle({
    Name = "Auto Factory",
    CurrentValue = Config.AutoFactory,
    Flag = "AutoFactory",
    Callback = function(Value)
        Config.AutoFactory = Value
        if Value then
            StartAutoFactory()
        end
    end
})

local AutoRipIndraToggle = WorldTab:CreateToggle({
    Name = "Auto Rip Indra",
    CurrentValue = Config.AutoRipIndra,
    Flag = "AutoRipIndra",
    Callback = function(Value)
        Config.AutoRipIndra = Value
        if Value then
            StartAutoRipIndra()
        end
    end
})

local AutoHolyTorchToggle = WorldTab:CreateToggle({
    Name = "Auto Holy Torch",
    CurrentValue = Config.AutoHolyTorch,
    Flag = "AutoHolyTorch",
    Callback = function(Value)
        Config.AutoHolyTorch = Value
        if Value then
            StartAutoHolyTorch()
        end
    end
})

-- Melee Tab
local MeleeTab = Window:CreateTab("Melee", nil)

-- Auto Melee Section
local AutoMeleeSection = MeleeTab:CreateSection("Auto Melee")
local AutoSuperhumanToggle = MeleeTab:CreateToggle({
    Name = "Auto Superhuman",
    CurrentValue = Config.AutoSuperhuman,
    Flag = "AutoSuperhuman",
    Callback = function(Value)
        Config.AutoSuperhuman = Value
        if Value then
            StartAutoSuperhuman()
        end
    end
})

local AutoDeathStepToggle = MeleeTab:CreateToggle({
    Name = "Auto Death Step",
    CurrentValue = Config.AutoDeathStep,
    Flag = "AutoDeathStep",
    Callback = function(Value)
        Config.AutoDeathStep = Value
        if Value then
            StartAutoDeathStep()
        end
    end
})

local AutoElectricClawToggle = MeleeTab:CreateToggle({
    Name = "Auto Electric Claw",
    CurrentValue = Config.AutoElectricClaw,
    Flag = "AutoElectricClaw",
    Callback = function(Value)
        Config.AutoElectricClaw = Value
        if Value then
            StartAutoElectricClaw()
        end
    end
})

local AutoDragonTalonToggle = MeleeTab:CreateToggle({
    Name = "Auto Dragon Talon",
    CurrentValue = Config.AutoDragonTalon,
    Flag = "AutoDragonTalon",
    Callback = function(Value)
        Config.AutoDragonTalon = Value
        if Value then
            StartAutoDragonTalon()
        end
    end
})

local AutoGodHumanToggle = MeleeTab:CreateToggle({
    Name = "Auto God Human",
    CurrentValue = Config.AutoGodHuman,
    Flag = "AutoGodHuman",
    Callback = function(Value)
        Config.AutoGodHuman = Value
        if Value then
            StartAutoGodHuman()
        end
    end
})

local AutoSharkManToggle = MeleeTab:CreateToggle({
    Name = "Auto Sharkman",
    CurrentValue = Config.AutoSharkMan,
    Flag = "AutoSharkMan",
    Callback = function(Value)
        Config.AutoSharkMan = Value
        if Value then
            StartAutoSharkMan()
        end
    end
})

local AutoBuyGhoulToggle = MeleeTab:CreateToggle({
    Name = "Auto Buy Ghoul",
    CurrentValue = Config.AutoBuyGhoul,
    Flag = "AutoBuyGhoul",
    Callback = function(Value)
        Config.AutoBuyGhoul = Value
        if Value then
            StartAutoBuyGhoul()
        end
    end
})

-- Haki Section
local HakiSection = MeleeTab:CreateSection("Haki")
local AutoHakiToggle = MeleeTab:CreateToggle({
    Name = "Auto Haki",
    CurrentValue = Config.AutoHaki,
    Flag = "AutoHaki",
    Callback = function(Value)
        Config.AutoHaki = Value
    end
})

local AutoBusoToggle = MeleeTab:CreateToggle({
    Name = "Auto Buso Haki",
    CurrentValue = Config.AutoBuso,
    Flag = "AutoBuso",
    Callback = function(Value)
        Config.AutoBuso = Value
    end
})

local AutoObservationToggle = MeleeTab:CreateToggle({
    Name = "Auto Observation",
    CurrentValue = Config.AutoObservation,
    Flag = "AutoObservation",
    Callback = function(Value)
        Config.AutoObservation = Value
        if Value then
            StartAutoObservation()
        end
    end
})

local AutoKenV2Toggle = MeleeTab:CreateToggle({
    Name = "Auto Ken V2",
    CurrentValue = Config.AutoKenV2,
    Flag = "AutoKenV2",
    Callback = function(Value)
        Config.AutoKenV2 = Value
        if Value then
            StartAutoKenV2()
        end
    end
})

local AutoGeppoToggle = MeleeTab:CreateToggle({
    Name = "Auto Geppo",
    CurrentValue = Config.AutoGeppo,
    Flag = "AutoGeppo",
    Callback = function(Value)
        Config.AutoGeppo = Value
        if Value then
            StartAutoGeppo()
        end
    end
})

local AutoSoruToggle = MeleeTab:CreateToggle({
    Name = "Auto Soru",
    CurrentValue = Config.AutoSoru,
    Flag = "AutoSoru",
    Callback = function(Value)
        Config.AutoSoru = Value
        if Value then
            StartAutoSoru()
        end
    end
})

-- Sword Tab
local SwordTab = Window:CreateTab("Sword", nil)

-- Auto Sword Section
local AutoSwordSection = SwordTab:CreateSection("Auto Sword")
local AutoBuyLegendarySwordToggle = SwordTab:CreateToggle({
    Name = "Auto Buy Legendary Sword",
    CurrentValue = Config.AutoBuyLegendarySword,
    Flag = "AutoBuyLegendarySword",
    Callback = function(Value)
        Config.AutoBuyLegendarySword = Value
        if Value then
            StartAutoBuyLegendarySword()
        end
    end
})

local AutoBuyEnchantmentToggle = SwordTab:CreateToggle({
    Name = "Auto Buy Enchantment",
    CurrentValue = Config.AutoBuyEnchantment,
    Flag = "AutoBuyEnchantment",
    Callback = function(Value)
        Config.AutoBuyEnchantment = Value
        if Value then
            StartAutoBuyEnchantment()
        end
    end
})

local AutoTushitaToggle = SwordTab:CreateToggle({
    Name = "Auto Tushita",
    CurrentValue = Config.AutoTushita,
    Flag = "AutoTushita",
    Callback = function(Value)
        Config.AutoTushita = Value
        if Value then
            StartAutoTushita()
        end
    end
})

local AutoYamaToggle = SwordTab:CreateToggle({
    Name = "Auto Yama",
    CurrentValue = Config.AutoYama,
    Flag = "AutoYama",
    Callback = function(Value)
        Config.AutoYama = Value
        if Value then
            StartAutoYama()
        end
    end
})

local AutoHallowSyctheToggle = SwordTab:CreateToggle({
    Name = "Auto Hallow Sycthe",
    CurrentValue = Config.AutoHallowSycthe,
    Flag = "AutoHallowSycthe",
    Callback = function(Value)
        Config.AutoHallowSycthe = Value
        if Value then
            StartAutoHallowSycthe()
        end
    end
})

local AutoSoulGuitarToggle = SwordTab:CreateToggle({
    Name = "Auto Soul Guitar",
    CurrentValue = Config.AutoSoulGuitar,
    Flag = "AutoSoulGuitar",
    Callback = function(Value)
        Config.AutoSoulGuitar = Value
        if Value then
            StartAutoSoulGuitar()
        end
    end
})

-- Mastery Section
local MasterySection = SwordTab:CreateSection("Mastery")
local AutoFarmSwordMasteryToggle = SwordTab:CreateToggle({
    Name = "Auto Farm Sword Mastery",
    CurrentValue = Config.AutoFarmSwordMastery,
    Flag = "AutoFarmSwordMastery",
    Callback = function(Value)
        Config.AutoFarmSwordMastery = Value
        if Value then
            StartAutoFarmSwordMastery()
        end
    end
})

local SelectedMasteryWeaponDropdown = SwordTab:CreateDropdown({
    Name = "Select Weapon for Mastery",
    Options = {"Saber", "Rengoku", "Twin Hooks", "Halloween Scythe", "Midnight Blade", "Yama", "Tushita", "Soul Guitar"},
    CurrentOption = Config.SelectedMasteryWeapon,
    Flag = "SelectedMasteryWeapon",
    Callback = function(Option)
        Config.SelectedMasteryWeapon = Option
    end
})

-- Fruit Tab
local FruitTab = Window:CreateTab(" Fruit", nil)

-- Auto Fruit Section
local AutoFruitSection = FruitTab:CreateSection("Auto Fruit")
local AutoRandomFruitToggle = FruitTab:CreateToggle({
    Name = "Auto Random Fruit",
    CurrentValue = Config.AutoRandomFruit,
    Flag = "AutoRandomFruit",
    Callback = function(Value)
        Config.AutoRandomFruit = Value
        if Value then
            StartAutoRandomFruit()
        end
    end
})

local AutoBuyFruitToggle = FruitTab:CreateToggle({
    Name = "Auto Buy Fruit",
    CurrentValue = Config.AutoBuyFruit,
    Flag = "AutoBuyFruit",
    Callback = function(Value)
        Config.AutoBuyFruit = Value
        if Value then
            StartAutoBuyFruit()
        end
    end
})

local AutoDropFruitToggle = FruitTab:CreateToggle({
    Name = "Auto Drop Fruit",
    CurrentValue = Config.AutoDropFruit,
    Flag = "AutoDropFruit",
    Callback = function(Value)
        Config.AutoDropFruit = Value
        if Value then
            StartAutoDropFruit()
        end
    end
})

local AutoStoreAllFruitToggle = FruitTab:CreateToggle({
    Name = "Auto Store All Fruit",
    CurrentValue = Config.AutoStoreAllFruit,
    Flag = "AutoStoreAllFruit",
    Callback = function(Value)
        Config.AutoStoreAllFruit = Value
        if Value then
            StartAutoStoreAllFruit()
        end
    end
})

local AutoSellAllFruitToggle = FruitTab:CreateToggle({
    Name = "Auto Sell All Fruit",
    CurrentValue = Config.AutoSellAllFruit,
    Flag = "AutoSellAllFruit",
    Callback = function(Value)
        Config.AutoSellAllFruit = Value
        if Value then
            StartAutoSellAllFruit()
        end
    end
})

local BringFruitToggle = FruitTab:CreateToggle({
    Name = "Bring Fruit",
    CurrentValue = Config.BringFruit,
    Flag = "BringFruit",
    Callback = function(Value)
        Config.BringFruit = Value
    end
})

-- Fruit Mastery Section
local FruitMasterySection = FruitTab:CreateSection("Fruit Mastery")
local AutoFarmFruitMasteryToggle = FruitTab:CreateToggle({
    Name = "Auto Farm Fruit Mastery",
    CurrentValue = Config.AutoFarmFruitMastery,
    Flag = "AutoFarmFruitMastery",
    Callback = function(Value)
        Config.AutoFarmFruitMastery = Value
        if Value then
            StartAutoFarmFruitMastery()
        end
    end
})

local SelectedFruitMasteryDropdown = FruitTab:CreateDropdown({
    Name = "Select Fruit for Mastery",
    Options = {"Light", "Dark", "Flame", "Ice", "Quake", "String", "Rumble", "Magma", "Human: Buddha", "Sand", "Bird: Phoenix", "Dough"},
    CurrentOption = Config.SelectedFruitMastery,
    Flag = "SelectedFruitMastery",
    Callback = function(Option)
        Config.SelectedFruitMastery = Option
    end
})

-- Setting Tab
local SettingTab = Window:CreateTab("Settings", nil)

-- Combat Settings Section
local CombatSettingsSection = SettingTab:CreateSection("Combat Settings")
local FastAttackToggle = SettingTab:CreateToggle({
    Name = "Fast Attack",
    CurrentValue = Config.FastAttack,
    Flag = "FastAttack",
    Callback = function(Value)
        Config.FastAttack = Value
    end
})

local SuperFastAttackToggle = SettingTab:CreateToggle({
    Name = "Super Fast Attack",
    CurrentValue = Config.SuperFastAttack,
    Flag = "SuperFastAttack",
    Callback = function(Value)
        Config.SuperFastAttack = Value
        if Value then
            EnableSuperFastAttack()
        end
    end
})

local BringNPCToggle = SettingTab:CreateToggle({
    Name = "Bring NPC",
    CurrentValue = Config.BringNPC,
    Flag = "BringNPC",
    Callback = function(Value)
        Config.BringNPC = Value
    end
})

local MagnetToggle = SettingTab:CreateToggle({
    Name = "Magnet",
    CurrentValue = Config.Magnet,
    Flag = "Magnet",
    Callback = function(Value)
        Config.Magnet = Value
    end
})

local MagnetDistanceSlider = SettingTab:CreateSlider({
    Name = "Magnet Distance",
    Range = {1, 5000},
    Increment = 10,
    Suffix = "Studs",
    CurrentValue = Config.MagnetDistance,
    Flag = "MagnetDistance",
    Callback = function(Value)
        Config.MagnetDistance = Value
    end
})

local SelectedWeaponDropdown = SettingTab:CreateDropdown({
    Name = "Selected Weapon",
    Options = {"Melee", "Sword", "Gun", "Fruit"},
    CurrentOption = Config.SelectedWeapon,
    Flag = "SelectedWeapon",
    Callback = function(Option)
        Config.SelectedWeapon = Option
    end
})

-- Server Settings Section
local ServerSettingsSection = SettingTab:CreateSection("Server Settings")
local AutoHopToggle = SettingTab:CreateToggle({
    Name = "Auto Hop Server",
    CurrentValue = Config.AutoHop,
    Flag = "AutoHop",
    Callback = function(Value)
        Config.AutoHop = Value
        if Value then
            StartAutoHop()
        end
    end
})

local HopWhenPlayerSlider = SettingTab:CreateSlider({
    Name = "Hop When Player",
    Range = {1, 50},
    Increment = 1,
    Suffix = "Players",
    CurrentValue = Config.HopWhenPlayer,
    Flag = "HopWhenPlayer",
    Callback = function(Value)
        Config.HopWhenPlayer = Value
    end
})

local HopAfterTimeSlider = SettingTab:CreateSlider({
    Name = "Hop After Time",
    Range = {60, 1800},
    Increment = 30,
    Suffix = "Seconds",
    CurrentValue = Config.HopAfterTime,
    Flag = "HopAfterTime",
    Callback = function(Value)
        Config.HopAfterTime = Value
    end
})

local HopLowerServerToggle = SettingTab:CreateToggle({
    Name = "Hop Lower Server",
    CurrentValue = Config.HopLowerServer,
    Flag = "HopLowerServer",
    Callback = function(Value)
        Config.HopLowerServer = Value
    end
})

local AutoRejoinToggle = SettingTab:CreateToggle({
    Name = "Auto Rejoin",
    CurrentValue = Config.AutoRejoin,
    Flag = "AutoRejoin",
    Callback = function(Value)
        Config.AutoRejoin = Value
    end
})

-- Performance Settings Section
local PerformanceSettingsSection = SettingTab:CreateSection("Performance Settings")
local SkipCutsceneToggle = SettingTab:CreateToggle({
    Name = "Skip Cutscene",
    CurrentValue = Config.SkipCutscene,
    Flag = "SkipCutscene",
    Callback = function(Value)
        Config.SkipCutscene = Value
    end
})

local DisableDamageAnimationToggle = SettingTab:CreateToggle({
    Name = "Disable Damage Animation",
    CurrentValue = Config.DisableDamageAnimation,
    Flag = "DisableDamageAnimation",
    Callback = function(Value)
        Config.DisableDamageAnimation = Value
        if Value then
            DisableDamageAnimation()
        end
    end
})

local RemoveEffectToggle = SettingTab:CreateToggle({
    Name = "Remove Effect",
    CurrentValue = Config.RemoveEffect,
    Flag = "RemoveEffect",
    Callback = function(Value)
        Config.RemoveEffect = Value
        if Value then
            RemoveEffect()
        end
    end
})

local WhiteScreenToggle = SettingTab:CreateToggle({
    Name = "White Screen",
    CurrentValue = Config.WhiteScreen,
    Flag = "WhiteScreen",
    Callback = function(Value)
        Config.WhiteScreen = Value
        if Value then
            EnableWhiteScreen()
        end
    end
})

local FPSBoostToggle = SettingTab:CreateToggle({
    Name = "FPS Boost",
    CurrentValue = Config.AutoFPSBoost,
    Flag = "AutoFPSBoost",
    Callback = function(Value)
        Config.AutoFPSBoost = Value
        if Value then
            EnableFPSBoost()
        end
    end
})

local GraphicsToggle = SettingTab:CreateToggle({
    Name = "Auto Graphics",
    CurrentValue = Config.AutoGraphics,
    Flag = "AutoGraphics",
    Callback = function(Value)
        Config.AutoGraphics = Value
        if Value then
            SetLowGraphics()
        end
    end
})

local AntiAFKToggle = SettingTab:CreateToggle({
    Name = "Anti AFK",
    CurrentValue = Config.AntiAFK,
    Flag = "AntiAFK",
    Callback = function(Value)
        Config.AntiAFK = Value
        if Value then
            EnableAntiAFK()
        end
    end
})

-- Movement Settings Section
local MovementSettingsSection = SettingTab:CreateSection("Movement Settings")
local WalkSpeedSlider = SettingTab:CreateSlider({
    Name = "Walk Speed",
    Range = {16, 500},
    Increment = 1,
    Suffix = "Speed",
    CurrentValue = Config.WalkSpeed,
    Flag = "WalkSpeed",
    Callback = function(Value)
        Config.WalkSpeed = Value
        LocalPlayer.Character.Humanoid.WalkSpeed = Value
    end
})

local JumpPowerSlider = SettingTab:CreateSlider({
    Name = "Jump Power",
    Range = {50, 500},
    Increment = 1,
    Suffix = "Power",
    CurrentValue = Config.JumpPower,
    Flag = "JumpPower",
    Callback = function(Value)
        Config.JumpPower = Value
        LocalPlayer.Character.Humanoid.JumpPower = Value
    end
})

local FlyToggle = SettingTab:CreateToggle({
    Name = "Fly",
    CurrentValue = Config.Fly,
    Flag = "Fly",
    Callback = function(Value)
        Config.Fly = Value
        if Value then
            EnableFly()
        else
            DisableFly()
        end
    end
})

local FlySpeedSlider = SettingTab:CreateSlider({
    Name = "Fly Speed",
    Range = {1, 500},
    Increment = 1,
    Suffix = "Speed",
    CurrentValue = Config.FlySpeed,
    Flag = "FlySpeed",
    Callback = function(Value)
        Config.FlySpeed = Value
    end
})

local NoClipToggle = SettingTab:CreateToggle({
    Name = "No Clip",
    CurrentValue = Config.NoClip,
    Flag = "NoClip",
    Callback = function(Value)
        Config.NoClip = Value
        if Value then
            EnableNoClip()
        end
    end
})

local WalkOnWaterToggle = SettingTab:CreateToggle({
    Name = "Walk On Water",
    CurrentValue = Config.WalkOnWater,
    Flag = "WalkOnWater",
    Callback = function(Value)
        Config.WalkOnWater = Value
        if Value then
            EnableWalkOnWater()
        end
    end
})

local InfEnergyToggle = SettingTab:CreateToggle({
    Name = "Infinite Energy",
    CurrentValue = Config.InfEnergy,
    Flag = "InfEnergy",
    Callback = function(Value)
        Config.InfEnergy = Value
        if Value then
            EnableInfEnergy()
        end
    end
})

-- Misc Settings Section
local MiscSettingsSection = SettingTab:CreateSection("Misc Settings")
local AutoClickToggle = SettingTab:CreateToggle({
    Name = "Auto Click",
    CurrentValue = Config.AutoClick,
    Flag = "AutoClick",
    Callback = function(Value)
        Config.AutoClick = Value
        if Value then
            StartAutoClick()
        end
    end
})

local AutoClickSpeedSlider = SettingTab:CreateSlider({
    Name = "Auto Click Speed",
    Range = {1, 100},
    Increment = 1,
    Suffix = "CPS",
    CurrentValue = Config.AutoClickSpeed,
    Flag = "AutoClickSpeed",
    Callback = function(Value)
        Config.AutoClickSpeed = Value
    end
})

local AimbotSkillToggle = SettingTab:CreateToggle({
    Name = "Aimbot Skill",
    CurrentValue = Config.AimbotSkill,
    Flag = "AimbotSkill",
    Callback = function(Value)
        Config.AimbotSkill = Value
    end
})

local ShowHitboxToggle = SettingTab:CreateToggle({
    Name = "Show Hitbox",
    CurrentValue = Config.ShowHitbox,
    Flag = "ShowHitbox",
    Callback = function(Value)
        Config.ShowHitbox = Value
        if Value then
            ShowHitbox()
        end
    end
})

local AutoSaveSettingToggle = SettingTab:CreateToggle({
    Name = "Auto Save Setting",
    CurrentValue = Config.AutoSaveSetting,
    Flag = "AutoSaveSetting",
    Callback = function(Value)
        Config.AutoSaveSetting = Value
    end
})

local LoadSettingToggle = SettingTab:CreateToggle({
    Name = "Load Setting",
    CurrentValue = Config.LoadSetting,
    Flag = "LoadSetting",
    Callback = function(Value)
        Config.LoadSetting = Value
        if Value then
            LoadSettings()
        end
    end
})

local SettingNameInput = SettingTab:CreateInput({
    Name = "Setting Name",
    PlaceholderText = "Default",
    RemoveTextAfterFocusLost = false,
    CurrentValue = Config.SettingName,
    Flag = "SettingName",
    Callback = function(Value)
        Config.SettingName = Value
    end
})

-- Webhook Section
local WebhookSection = SettingTab:CreateSection("Webhook")
local WebhookToggle = SettingTab:CreateToggle({
    Name = "Enable Webhook",
    CurrentValue = Config.Webhook,
    Flag = "Webhook",
    Callback = function(Value)
        Config.Webhook = Value
    end
})

local WebhookUrlInput = SettingTab:CreateInput({
    Name = "Webhook URL",
    PlaceholderText = "https://discord.com/api/webhooks/...",
    RemoveTextAfterFocusLost = false,
    CurrentValue = Config.WebhookUrl,
    Flag = "WebhookUrl",
    Callback = function(Value)
        Config.WebhookUrl = Value
    end
})

local DiscordIdInput = SettingTab:CreateInput({
    Name = "Discord ID",
    PlaceholderText = "123456789012345678",
    RemoveTextAfterFocusLost = false,
    CurrentValue = Config.DiscordId,
    Flag = "DiscordId",
    Callback = function(Value)
        Config.DiscordId = Value
    end
})

local AutoSendStatsToggle = SettingTab:CreateToggle({
    Name = "Auto Send Stats",
    CurrentValue = Config.AutoSendStats,
    Flag = "AutoSendStats",
    Callback = function(Value)
        Config.AutoSendStats = Value
        if Value then
            StartAutoSendStats()
        end
    end
})

local SendStatsIntervalSlider = SettingTab:CreateSlider({
    Name = "Send Stats Interval",
    Range = {60, 3600},
    Increment = 60,
    Suffix = "Seconds",
    CurrentValue = Config.SendStatsInterval,
    Flag = "SendStatsInterval",
    Callback = function(Value)
        Config.SendStatsInterval = Value
    end
})

-- Notify Section
local NotifySection = SettingTab:CreateSection("Notify")
local AutoNotifyToggle = SettingTab:CreateToggle({
    Name = "Auto Notify",
    CurrentValue = Config.AutoNotify,
    Flag = "AutoNotify",
    Callback = function(Value)
        Config.AutoNotify = Value
    end
})

local NotifyWhenDoneToggle = SettingTab:CreateToggle({
    Name = "Notify When Done",
    CurrentValue = Config.NotifyWhenDone,
    Flag = "NotifyWhenDone",
    Callback = function(Value)
        Config.NotifyWhenDone = Value
    end
})

local NotifyWhenErrorToggle = SettingTab:CreateToggle({
    Name = "Notify When Error",
    CurrentValue = Config.NotifyWhenError,
    Flag = "NotifyWhenError",
    Callback = function(Value)
        Config.NotifyWhenError = Value
    end
})

local NotifyWhenHopToggle = SettingTab:CreateToggle({
    Name = "Notify When Hop",
    CurrentValue = Config.NotifyWhenHop,
    Flag = "NotifyWhenHop",
    Callback = function(Value)
        Config.NotifyWhenHop = Value
    end
})

local NotifyWhenBossToggle = SettingTab:CreateToggle({
    Name = "Notify When Boss",
    CurrentValue = Config.NotifyWhenBoss,
    Flag = "NotifyWhenBoss",
    Callback = function(Value)
        Config.NotifyWhenBoss = Value
    end
})

local NotifyWhenChestToggle = SettingTab:CreateToggle({
    Name = "Notify When Chest",
    CurrentValue = Config.NotifyWhenChest,
    Flag = "NotifyWhenChest",
    Callback = function(Value)
        Config.NotifyWhenChest = Value
    end
})

-- Player Tab
local PlayerTab = Window:CreateTab("Player", nil)

-- Player List Section
local PlayerListSection = PlayerTab:CreateSection("Player List")
local PlayerList = {}
local PlayerDropdown = PlayerTab:CreateDropdown({
    Name = "Select Player",
    Options = {""},
    CurrentOption = "",
    Flag = "SelectedPlayer",
    Callback = function(Option)
        Config.SelectedPlayer = Option
    end
})

-- Update player list
local function UpdatePlayerList()
    local players = Players:GetPlayers()
    local options = {}
    for _, player in pairs(players) do
        if player ~= LocalPlayer then
            table.insert(options, player.Name)
        end
    end
    PlayerDropdown:Refresh(options, true)
end

UpdatePlayerList()
Players.PlayerAdded:Connect(UpdatePlayerList)
Players.PlayerRemoving:Connect(UpdatePlayerList)

-- Player Control Section
local PlayerControlSection = PlayerTab:CreateSection("Player Control")
local TeleportToPlayerButton = PlayerTab:CreateButton({
    Name = "Teleport To Player",
    Callback = function()
        local targetPlayer = Config.SelectedPlayer
        if targetPlayer and targetPlayer ~= "" then
            local target = Players:FindFirstChild(targetPlayer)
            if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
                LocalPlayer.Character:SetPrimaryPartCFrame(target.Character.HumanoidRootPart.CFrame)
            end
        end
    end
})

local BringPlayerButton = PlayerTab:CreateButton({
    Name = "Bring Player",
    Callback = function()
        local targetPlayer = Config.SelectedPlayer
        if targetPlayer and targetPlayer ~= "" then
            local target = Players:FindFirstChild(targetPlayer)
            if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
                target.Character:SetPrimaryPartCFrame(LocalPlayer.Character.HumanoidRootPart.CFrame)
            end
        end
    end
})

local KillPlayerToggle = PlayerTab:CreateToggle({
    Name = "Auto Kill Player",
    CurrentValue = Config.AutoKillPlayer,
    Flag = "AutoKillPlayer",
    Callback = function(Value)
        Config.AutoKillPlayer = Value
        if Value then
            StartAutoKillPlayer()
        end
    end
})

local KillPlayerGunToggle = PlayerTab:CreateToggle({
    Name = "Kill Player with Gun",
    CurrentValue = Config.AutoKillPlayerGun,
    Flag = "AutoKillPlayerGun",
    Callback = function(Value)
        Config.AutoKillPlayerGun = Value
    end
})

local KillPlayerMeleeToggle = PlayerTab:CreateToggle({
    Name = "Kill Player with Melee",
    CurrentValue = Config.AutoKillPlayerMelee,
    Flag = "AutoKillPlayerMelee",
    Callback = function(Value)
        Config.AutoKillPlayerMelee = Value
    end
})

local KillPlayerSwordToggle = PlayerTab:CreateToggle({
    Name = "Kill Player with Sword",
    CurrentValue = Config.AutoKillPlayerSword,
    Flag = "AutoKillPlayerSword",
    Callback = function(Value)
        Config.AutoKillPlayerSword = Value
    end
})

-- Spectate Section
local SpectateSection = PlayerTab:CreateSection("Spectate")
local SpectateButton = PlayerTab:CreateButton({
    Name = "Spectate Player",
    Callback = function()
        local targetPlayer = Config.SelectedPlayer
        if targetPlayer and targetPlayer ~= "" then
            local target = Players:FindFirstChild(targetPlayer)
            if target then
                LocalPlayer.Character.Humanoid:Destroy()
                LocalPlayer.CharacterAdded:Wait()
                wait(1)
                LocalPlayer.Character:WaitForChild("Humanoid")
                LocalPlayer.Character.Humanoid:ChangeState(15)
                wait(0.5)
                LocalPlayer.Character:Destroy()
                workspace.CurrentCamera.CameraSubject = target.Character.Humanoid
            end
        end
    end
})

local UnspectateButton = PlayerTab:CreateButton({
    Name = "Unspectate",
    Callback = function()
        if LocalPlayer.Character then
            workspace.CurrentCamera.CameraSubject = LocalPlayer.Character.Humanoid
        end
    end
})

-- Information Tab
local InfoTab = Window:CreateTab("ℹInfo", nil)

-- Status Section
local StatusSection = InfoTab:CreateSection("Status")
local LevelLabel = InfoTab:CreateLabel("Level: Loading...")
local BeliLabel = InfoTab:CreateLabel("Beli: Loading...")
local FragmentLabel = InfoTab:CreateLabel("Fragment: Loading...")
local RaceLabel = InfoTab:CreateLabel("Race: Loading...")
local MeleeLabel = InfoTab:CreateLabel("Melee: Loading...")
local DefenseLabel = InfoTab:CreateLabel("Defense: Loading...")
local SwordLabel = InfoTab:CreateLabel("Sword: Loading...")
local GunLabel = InfoTab:CreateLabel("Gun: Loading...")
local FruitLabel = InfoTab:CreateLabel("Fruit: Loading...")
local BusoLabel = InfoTab:CreateLabel("Buso Haki: Loading...")
local ObservationLabel = InfoTab:CreateLabel("Observation Haki: Loading...")
local GeppoLabel = InfoTab:CreateLabel("Geppo: Loading...")
local SoruLabel = InfoTab:CreateLabel("Soru: Loading...")
local KenLabel = InfoTab:CreateLabel("Ken Haki: Loading...")

-- Update status
local function UpdateStatus()
    pcall(function()
        local level = LocalPlayer.Data.Level.Value
        local beli = LocalPlayer.Data.Beli.Value
        local fragment = LocalPlayer.Data.Fragments.Value
        local race = LocalPlayer.Data.Race.Value
        local melee = LocalPlayer.Data.Stats.Melee.Level.Value
        local defense = LocalPlayer.Data.Stats.Defense.Level.Value
        local sword = LocalPlayer.Data.Stats.Sword.Level.Value
        local gun = LocalPlayer.Data.Stats.Gun.Level.Value
        local fruit = LocalPlayer.Data.Stats["Demon Fruit"].Level.Value
        local buso = LocalPlayer.Data.Stats["Buso Haki"].Level.Value
        local observation = LocalPlayer.Data.Stats["Observation Haki"].Level.Value
        local geppo = LocalPlayer.Data.Stats.Geppo.Level.Value
        local soru = LocalPlayer.Data.Stats.Soru.Level.Value
        local ken = LocalPlayer.Data.Stats.Ken.Level.Value
        
        LevelLabel:Set("Level: " .. tostring(level))
        BeliLabel:Set("Beli: " .. tostring(beli))
        FragmentLabel:Set("Fragment: " .. tostring(fragment))
        RaceLabel:Set("Race: " .. tostring(race))
        MeleeLabel:Set("Melee: " .. tostring(melee))
        DefenseLabel:Set("Defense: " .. tostring(defense))
        SwordLabel:Set("Sword: " .. tostring(sword))
        GunLabel:Set("Gun: " .. tostring(gun))
        FruitLabel:Set("Fruit: " .. tostring(fruit))
        BusoLabel:Set("Buso Haki: " .. tostring(buso))
        ObservationLabel:Set("Observation Haki: " .. tostring(observation))
        GeppoLabel:Set("Geppo: " .. tostring(geppo))
        SoruLabel:Set("Soru: " .. tostring(soru))
        KenLabel:Set("Ken Haki: " .. tostring(ken))
    end)
end

spawn(function()
    while wait(1) do
        UpdateStatus()
    end
end)

-- Server Info Section
local ServerInfoSection = InfoTab:CreateSection("Server Info")
local PlayerCountLabel = InfoTab:CreateLabel("Player Count: " .. #Players:GetPlayers())
local ServerIDLabel = InfoTab:CreateLabel("Server ID: Loading...")
local PingLabel = InfoTab:CreateLabel("Ping: Loading...")
local FPSLabel = InfoTab:CreateLabel("FPS: Loading...")

-- Update server info
spawn(function()
    while wait(1) do
        PlayerCountLabel:Set("Player Count: " .. #Players:GetPlayers())
        ServerIDLabel:Set("Server ID: " .. game.JobId)
        
        -- Ping
        local ping = math.floor(game:GetService("Stats").Network.ServerStatsItem["Data Ping"]:GetValue())
        PingLabel:Set("Ping: " .. ping .. "ms")
        
        -- FPS
        local fps = math.floor(1 / game:GetService("RunService").RenderStepped:Wait())
        FPSLabel:Set("FPS: " .. fps)
    end
end)

-- Script Info Section
local ScriptInfoSection = InfoTab:CreateSection("Script Info")
local VersionLabel = InfoTab:CreateLabel("Version: 2.0.0")
local AuthorLabel = InfoTab:CreateLabel("Author: Astra Team")
local UpdateLabel = InfoTab:CreateLabel("Last Update: 2024")
local NoteLabel = InfoTab:CreateLabel("Note: This is a Kaitun Leviathan script")

-- Buttons Section
local ButtonsSection = InfoTab:CreateSection("Buttons")
local CopyServerIDButton = InfoTab:CreateButton({
    Name = "Copy Server ID",
    Callback = function()
        setclipboard(game.JobId)
    end
})

local RejoinButton = InfoTab:CreateButton({
    Name = "Rejoin Server",
    Callback = function()
        TeleportService:Teleport(game.PlaceId, LocalPlayer)
    end
})

local ServerHopButton = InfoTab:CreateButton({
    Name = "Server Hop",
    Callback = function()
        ServerHop()
    end
})

local DiscordButton = InfoTab:CreateButton({
    Name = "Join Discord",
    Callback = function()
        local request = syn and syn.request or request
        request({
            Url = "http://127.0.0.1:6463/rpc?v=1",
            Method = "POST",
            Headers = {
                ["Content-Type"] = "application/json",
                ["Origin"] = "https://discord.com"
            },
            Body = game:GetService("HttpService"):JSONEncode({
                cmd = "INVITE_BROWSER",
                args = {
                    code = "astraxhub"
                },
                nonce = game:GetService("HttpService"):GenerateGUID(false)
            })
        })
    end
})

-- Initialize các function chính
function StartAutoFarmLevel()
    spawn(function()
        while Config.AutoFarmLevel do
            wait()
            -- Code auto farm level
        end
    end)
end

function StartAutoFarmBoss()
    spawn(function()
        while Config.AutoFarmBoss do
            wait()
            -- Code auto farm boss
        end
    end)
end

function StartAutoLeviathan()
    spawn(function()
        while Config.AutoLeviathan do
            wait()
            -- Code auto leviathan
        end
    end)
end

-- Thêm các function khác ở đây...

Rayfield:LoadConfiguration()
-- Phần 2: Chức năng chính và hệ thống farm

-- ============================================
-- UTILITY FUNCTIONS
-- ============================================

local function GetPlayerLevel()
    local level = 1
    pcall(function()
        level = LocalPlayer.Data.Level.Value
    end)
    return level
end

local function GetBeli()
    local beli = 0
    pcall(function()
        beli = LocalPlayer.Data.Beli.Value
    end)
    return beli
end

local function GetFragments()
    local fragments = 0
    pcall(function()
        fragments = LocalPlayer.Data.Fragments.Value
    end)
    return fragments
end

local function GetCurrentWeapon()
    local weapon = nil
    pcall(function()
        for _, v in pairs(LocalPlayer.Backpack:GetChildren()) do
            if v:IsA("Tool") then
                weapon = v
                break
            end
        end
        if not weapon and LocalPlayer.Character then
            for _, v in pairs(LocalPlayer.Character:GetChildren()) do
                if v:IsA("Tool") then
                    weapon = v
                    break
                end
            end
        end
    end)
    return weapon
end

local function EquipWeapon(toolName)
    pcall(function()
        if LocalPlayer.Backpack:FindFirstChild(toolName) then
            LocalPlayer.Character.Humanoid:EquipTool(LocalPlayer.Backpack[toolName])
        end
    end)
end

local function GetFruitInInventory()
    local fruits = {}
    pcall(function()
        for _, v in pairs(LocalPlayer.Backpack:GetChildren()) do
            if v:IsA("Tool") and string.find(v.Name, "Fruit") then
                table.insert(fruits, v)
            end
        end
    end)
    return fruits
end

local function GetCurrentSea()
    local sea = "First Sea"
    pcall(function()
        if game:GetService("Workspace").Map:FindFirstChild("MysticIsland") then
            sea = "Third Sea"
        elseif game:GetService("Workspace").Map:FindFirstChild("IceCastle") then
            sea = "Second Sea"
        end
    end)
    return sea
end

local function GetNearestNPC(range)
    local nearest = nil
    local distance = range or math.huge
    pcall(function()
        for _, v in pairs(Workspace.NPCs:GetChildren()) do
            if v:FindFirstChild("HumanoidRootPart") then
                local dist = (LocalPlayer.Character.HumanoidRootPart.Position - v.HumanoidRootPart.Position).Magnitude
                if dist < distance then
                    distance = dist
                    nearest = v
                end
            end
        end
    end)
    return nearest, distance
end

local function GetNearestMob(range)
    local nearest = nil
    local distance = range or math.huge
    pcall(function()
        for _, v in pairs(Workspace.Enemies:GetChildren()) do
            if v:FindFirstChild("HumanoidRootPart") and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
                local dist = (LocalPlayer.Character.HumanoidRootPart.Position - v.HumanoidRootPart.Position).Magnitude
                if dist < distance then
                    distance = dist
                    nearest = v
                end
            end
        end
    end)
    return nearest, distance
end

local function GetNearestBoss(range)
    local nearest = nil
    local distance = range or math.huge
    pcall(function()
        for _, v in pairs(Workspace.Bosses:GetChildren()) do
            if v:FindFirstChild("HumanoidRootPart") and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
                local dist = (LocalPlayer.Character.HumanoidRootPart.Position - v.HumanoidRootPart.Position).Magnitude
                if dist < distance then
                    distance = dist
                    nearest = v
                end
            end
        end
    end)
    return nearest, distance
end

local function GetNearestChest(range)
    local nearest = nil
    local distance = range or math.huge
    pcall(function()
        for _, v in pairs(Workspace:GetChildren()) do
            if string.find(v.Name, "Chest") and v:FindFirstChild("Chest") then
                local dist = (LocalPlayer.Character.HumanoidRootPart.Position - v.Chest.Position).Magnitude
                if dist < distance then
                    distance = dist
                    nearest = v
                end
            end
        end
    end)
    return nearest, distance
end

local function TeleportTo(position, callback)
    pcall(function()
        local chr = LocalPlayer.Character
        if chr and chr:FindFirstChild("HumanoidRootPart") then
            if Config.NoClip then
                for _, v in pairs(chr:GetDescendants()) do
                    if v:IsA("BasePart") then
                        v.CanCollide = false
                    end
                end
            end
            chr.HumanoidRootPart.CFrame = position
            if callback then
                callback()
            end
        end
    end)
end

local function TweenTo(position, callback)
    pcall(function()
        local chr = LocalPlayer.Character
        if chr and chr:FindFirstChild("HumanoidRootPart") then
            local tweenService = game:GetService("TweenService")
            local tweenInfo = TweenInfo.new((chr.HumanoidRootPart.Position - position.Position).Magnitude / Config.WalkSpeed, Enum.EasingStyle.Linear)
            local tween = tweenService:Create(chr.HumanoidRootPart, tweenInfo, {CFrame = position})
            tween:Play()
            tween.Completed:Connect(function()
                if callback then
                    callback()
                end
            end)
        end
    end)
end

local function UseFastAttack()
    if Config.FastAttack then
        pcall(function()
            local CombatFramework = require(game:GetService("Players").LocalPlayer.PlayerScripts.CombatFramework)
            local CameraShaker = require(game.ReplicatedStorage.Util.CameraShaker)
            
            CameraShaker:Stop()
            CombatFramework.activeController.attacking = false
            CombatFramework.activeController.timeToNextAttack = 0
            CombatFramework.activeController.hitboxMagnitude = 50
            CombatFramework.activeController.increment = 3
            CombatFramework.activeController.blocking = false
            CombatFramework.activeController.timeToNextBlock = 0
        end)
    end
end

local function UseSkills()
    pcall(function()
        local VirtualUser = game:GetService("VirtualUser")
        VirtualUser:CaptureController()
        VirtualUser:ClickButton1(Vector2.new(0,0))
        
        if Config.SelectedWeapon == "Melee" then
            local args = {
                [1] = "Energy"
            }
            game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
        end
    end)
end

local function BringNPC()
    if Config.BringNPC then
        pcall(function()
            local npc = GetNearestNPC(500)
            if npc then
                npc.HumanoidRootPart.CFrame = LocalPlayer.Character.HumanoidRootPart.CFrame
            end
        end)
    end
end

local function BringMob()
    if Config.BringNPC then
        pcall(function()
            local mob = GetNearestMob(500)
            if mob then
                mob.HumanoidRootPart.CFrame = LocalPlayer.Character.HumanoidRootPart.CFrame
            end
        end)
    end
end

local function UseMagnet()
    if Config.Magnet then
        pcall(function()
            for _, v in pairs(Workspace.Enemies:GetChildren()) do
                if v:FindFirstChild("HumanoidRootPart") and v:FindFirstChild("Humanoid") and v.Humanoid.Health <= 0 then
                    local distance = (LocalPlayer.Character.HumanoidRootPart.Position - v.HumanoidRootPart.Position).Magnitude
                    if distance <= Config.MagnetDistance then
                        v.HumanoidRootPart.CFrame = LocalPlayer.Character.HumanoidRootPart.CFrame
                    end
                end
            end
        end)
    end
end

-- ============================================
-- AUTO FARM FUNCTIONS
-- ============================================

function StartAutoFarmLevel()
    spawn(function()
        while Config.AutoFarmLevel do
            pcall(function()
                local mob, distance = GetNearestMob(500)
                if mob and distance < 50 then
                    -- Di chuyển đến mob
                    LocalPlayer.Character.HumanoidRootPart.CFrame = mob.HumanoidRootPart.CFrame * CFrame.new(0, 0, 5)
                    
                    -- Tấn công
                    UseFastAttack()
                    UseSkills()
                    
                    -- Mang mob đến nếu cần
                    BringMob()
                    
                    -- Sử dụng magnet
                    UseMagnet()
                else
                    -- Tìm mob mới
                    local mobs = {}
                    for _, v in pairs(Workspace.Enemies:GetChildren()) do
                        if v:FindFirstChild("HumanoidRootPart") and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
                            table.insert(mobs, v)
                        end
                    end
                    
                    if #mobs > 0 then
                        local target = mobs[math.random(1, #mobs)]
                        TweenTo(target.HumanoidRootPart.CFrame * CFrame.new(0, 0, 10))
                    end
                end
            end)
            wait(0.1)
        end
    end)
end

function StartAutoFarmBoss()
    spawn(function()
        while Config.AutoFarmBoss do
            pcall(function()
                if Config.SelectedBoss == "" then
                    return
                end
                
                -- Tìm boss
                local boss = nil
                for _, v in pairs(Workspace.Bosses:GetChildren()) do
                    if string.find(v.Name, Config.SelectedBoss) and v:FindFirstChild("HumanoidRootPart") and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
                        boss = v
                        break
                    end
                end
                
                if boss then
                    -- Di chuyển đến boss
                    local distance = (LocalPlayer.Character.HumanoidRootPart.Position - boss.HumanoidRootPart.Position).Magnitude
                    if distance > 50 then
                        TweenTo(boss.HumanoidRootPart.CFrame * CFrame.new(0, 0, 10))
                    else
                        LocalPlayer.Character.HumanoidRootPart.CFrame = boss.HumanoidRootPart.CFrame * CFrame.new(0, 0, 10)
                    end
                    
                    -- Tấn công boss
                    UseFastAttack()
                    UseSkills()
                    
                    -- Kích hoạt haki nếu cần
                    if Config.AutoBuso then
                        local args = {
                            [1] = "Buso"
                        }
                        game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
                    end
                else
                    -- Boss chưa spawn, chờ đợi
                    local bossSpawnLocation = GetBossSpawnLocation(Config.SelectedBoss)
                    if bossSpawnLocation then
                        TweenTo(bossSpawnLocation)
                    end
                end
            end)
            wait(0.1)
        end
    end)
end

function GetBossSpawnLocation(bossName)
    local locations = {
        ["Sea Beast"] = CFrame.new(-1692.22998, 95.3271484, -968.974976),
        ["Leviathan"] = CFrame.new(-9542.45703, 21.7500038, 5887.07568),
        ["Shark"] = CFrame.new(-4087.41211, 18.4978657, -3291.95654),
        ["Terrorshark"] = CFrame.new(-2015.96228, 72.9663467, -899.315063),
        ["Cursed Captain"] = CFrame.new(916.928528, 181.057709, 33422),
        ["Darkbeard"] = CFrame.new(3780.03076, 24.5863686, -3499.42578),
        ["Soul Reaper"] = CFrame.new(-9515.62109, 315.013092, 6691.12012)
    }
    return locations[bossName]
end

-- ============================================
-- LEVIATHAN FUNCTIONS
-- ============================================

function StartAutoLeviathan()
    spawn(function()
        while Config.AutoLeviathan do
            pcall(function()
                local sea = GetCurrentSea()
                if sea ~= "Third Sea" then
                    -- Chưa ở Third Sea, không thể farm Leviathan
                    return
                end
                
                -- Kiểm tra Leviathan có đang spawn không
                local leviathan = nil
                for _, v in pairs(Workspace.Bosses:GetChildren()) do
                    if string.find(v.Name, "Leviathan") and v:FindFirstChild("HumanoidRootPart") then
                        leviathan = v
                        break
                    end
                end
                
                if leviathan then
                    -- Di chuyển đến Leviathan
                    local distance = (LocalPlayer.Character.HumanoidRootPart.Position - leviathan.HumanoidRootPart.Position).Magnitude
                    if distance > 100 then
                        TweenTo(leviathan.HumanoidRootPart.CFrame * CFrame.new(0, 30, 50))
                    else
                        -- Giữ khoảng cách an toàn với Leviathan
                        LocalPlayer.Character.HumanoidRootPart.CFrame = leviathan.HumanoidRootPart.CFrame * CFrame.new(0, 30, 50)
                    end
                    
                    -- Tấn công Leviathan
                    UseFastAttack()
                    UseSkills()
                    
                    -- Kích hoạt haki
                    if Config.AutoBuso then
                        local args = {
                            [1] = "Buso"
                        }
                        game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
                    end
                    
                    -- Tránh tấn công của Leviathan
                    AvoidLeviathanAttack(leviathan)
                else
                    -- Leviathan chưa spawn, kiểm tra điều kiện spawn
                    CheckLeviathanSpawnCondition()
                    
                    -- Di chuyển đến vị trí spawn Leviathan
                    TweenTo(CFrame.new(-9542.45703, 21.7500038, 5887.07568))
                end
            end)
            wait(0.1)
        end
    end)
end

function AvoidLeviathanAttack(leviathan)
    pcall(function()
        -- Kiểm tra nếu Leviathan sắp tấn công
        if leviathan:FindFirstChild("Humanoid") then
            local animator = leviathan.Humanoid:FindFirstChild("Animator")
            if animator then
                -- Tránh tấn công bằng cách di chuyển
                LocalPlayer.Character.HumanoidRootPart.CFrame = LocalPlayer.Character.HumanoidRootPart.CFrame * CFrame.new(0, 0, 10)
            end
        end
    end)
end

function CheckLeviathanSpawnCondition()
    -- Kiểm tra điều kiện spawn Leviathan
    local tideCycle = Workspace:FindFirstChild("TideCycle")
    if tideCycle then
        -- Xử lý logic kiểm tra thủy triều
    end
end

function StartAutoKillSeaBeast()
    spawn(function()
        while Config.AutoKillSeaBeast do
            pcall(function()
                -- Tìm Sea Beast
                local seaBeast = nil
                for _, v in pairs(Workspace.Bosses:GetChildren()) do
                    if string.find(v.Name, "Sea Beast") and v:FindFirstChild("HumanoidRootPart") then
                        seaBeast = v
                        break
                    end
                end
                
                if not seaBeast then
                    -- Tìm trong Enemies
                    for _, v in pairs(Workspace.Enemies:GetChildren()) do
                        if string.find(v.Name, "Sea Beast") and v:FindFirstChild("HumanoidRootPart") then
                            seaBeast = v
                            break
                        end
                    end
                end
                
                if seaBeast then
                    -- Di chuyển đến Sea Beast
                    local distance = (LocalPlayer.Character.HumanoidRootPart.Position - seaBeast.HumanoidRootPart.Position).Magnitude
                    if distance > 50 then
                        TweenTo(seaBeast.HumanoidRootPart.CFrame * CFrame.new(0, 0, 20))
                    else
                        LocalPlayer.Character.HumanoidRootPart.CFrame = seaBeast.HumanoidRootPart.CFrame * CFrame.new(0, 0, 20)
                    end
                    
                    -- Tấn công Sea Beast
                    UseFastAttack()
                    UseSkills()
                    
                    -- Kích hoạt haki
                    if Config.AutoBuso then
                        local args = {
                            [1] = "Buso"
                        }
                        game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
                    end
                else
                    -- Di chuyển đến khu vực có Sea Beast
                    if GetCurrentSea() == "First Sea" then
                        TweenTo(CFrame.new(-1692.22998, 95.3271484, -968.974976))
                    elseif GetCurrentSea() == "Second Sea" then
                        TweenTo(CFrame.new(-4087.41211, 18.4978657, -3291.95654))
                    else
                        TweenTo(CFrame.new(-2015.96228, 72.9663467, -899.315063))
                    end
                end
            end)
            wait(0.1)
        end
    end)
end

function StartAutoFarmSeaBeast()
    spawn(function()
        while Config.AutoFarmSeaBeast do
            pcall(function()
                -- Kết hợp giữa tìm và giết Sea Beast
                local seaBeast = nil
                
                -- Ưu tiên tìm trong Bosses
                for _, v in pairs(Workspace.Bosses:GetChildren()) do
                    if string.find(v.Name, "Sea Beast") then
                        seaBeast = v
                        break
                    end
                end
                
                -- Nếu không có trong Bosses, tìm trong Enemies
                if not seaBeast then
                    for _, v in pairs(Workspace.Enemies:GetChildren()) do
                        if string.find(v.Name, "Sea Beast") then
                            seaBeast = v
                            break
                        end
                    end
                end
                
                if seaBeast then
                    -- Di chuyển và tấn công
                    local distance = (LocalPlayer.Character.HumanoidRootPart.Position - seaBeast.HumanoidRootPart.Position).Magnitude
                    if distance > 30 then
                        TweenTo(seaBeast.HumanoidRootPart.CFrame * CFrame.new(0, 0, 15))
                    end
                    
                    UseFastAttack()
                    UseSkills()
                    
                    -- Thu thập vật phẩm
                    UseMagnet()
                else
                    -- Di chuyển đến vị trí spawn Sea Beast
                    local spawnLocation = GetSeaBeastSpawnLocation()
                    if spawnLocation then
                        TweenTo(spawnLocation)
                    end
                end
            end)
            wait(0.1)
        end
    end)
end

function GetSeaBeastSpawnLocation()
    local sea = GetCurrentSea()
    if sea == "First Sea" then
        return CFrame.new(-1692.22998, 95.3271484, -968.974976)
    elseif sea == "Second Sea" then
        return CFrame.new(-4087.41211, 18.4978657, -3291.95654)
    else
        return CFrame.new(-2015.96228, 72.9663467, -899.315063)
    end
end

-- ============================================
-- QUEST FUNCTIONS
-- ============================================

function StartAutoFarmQuest()
    spawn(function()
        while Config.AutoFarmQuest do
            pcall(function()
                if Config.SelectedQuest == "" then
                    return
                end
                
                if Config.SelectedQuest == "Bartilo" then
                    AutoBartiloQuest()
                elseif Config.SelectedQuest == "Rengoku" then
                    AutoRengokuQuest()
                elseif Config.SelectedQuest == "Elite Hunter" then
                    AutoEliteHunterQuest()
                elseif Config.SelectedQuest == "Pirate Raid" then
                    AutoPirateRaidQuest()
                elseif Config.SelectedQuest == "Factory" then
                    AutoFactoryQuest()
                end
            end)
            wait(0.1)
        end
    end)
end

function AutoBartiloQuest()
    local level = GetPlayerLevel()
    if level >= 850 then
        -- Chấp nhận quest
        local args = {
            [1] = "StartQuest",
            [2] = "BartiloQuest",
            [3] = 1
        }
        game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
        
        -- Di chuyển đến đảo Bartilo
        TweenTo(CFrame.new(-456.289093, 73.0200958, 299.895966))
        
        -- Tìm và giết quái
        local mob, distance = GetNearestMob(500)
        if mob and distance < 50 then
            LocalPlayer.Character.HumanoidRootPart.CFrame = mob.HumanoidRootPart.CFrame * CFrame.new(0, 0, 5)
            UseFastAttack()
            UseSkills()
        end
    end
end

function AutoRengokuQuest()
    -- Kiểm tra đang ở Second Sea
    if GetCurrentSea() == "Second Sea" then
        -- Lấy quest Rengoku
        local args = {
            [1] = "Rengoku",
            [2] = 1
        }
        game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
        
        -- Di chuyển đến Snow Mountain
        TweenTo(CFrame.new(1269.60498, 459.752686, -5170.18311))
        
        -- Tìm quái Yeti
        local mob, distance = GetNearestMob(500)
        if mob and string.find(mob.Name, "Snow") and distance < 50 then
            LocalPlayer.Character.HumanoidRootPart.CFrame = mob.HumanoidRootPart.CFrame * CFrame.new(0, 0, 5)
            UseFastAttack()
            UseSkills()
        end
    end
end

-- ============================================
-- AUTO ITEM FUNCTIONS
-- ============================================

function StartAutoSaber()
    spawn(function()
        while Config.AutoSaber do
            pcall(function()
                local level = GetPlayerLevel()
                if level >= 200 and GetCurrentSea() == "First Sea" then
                    -- Kiểm tra đã có Saber chưa
                    local hasSaber = false
                    if LocalPlayer.Backpack:FindFirstChild("Saber") or LocalPlayer.Character:FindFirstChild("Saber") then
                        hasSaber = true
                    end
                    
                    if not hasSaber then
                        -- Bắt đầu quest Saber
                        local args = {
                            [1] = "Saber"
                        }
                        game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
                        
                        -- Di chuyển đến Jungle
                        TweenTo(CFrame.new(-1253.15344, 11.2010355, 341.72699))
                        
                        -- Tìm và giết quái
                        local mob, distance = GetNearestMob(500)
                        if mob and distance < 50 then
                            LocalPlayer.Character.HumanoidRootPart.CFrame = mob.HumanoidRootPart.CFrame * CFrame.new(0, 0, 5)
                            UseFastAttack()
                            UseSkills()
                        end
                    end
                end
            end)
            wait(0.1)
        end
    end)
end

function StartAutoPole()
    spawn(function()
        while Config.AutoPole do
            pcall(function()
                if GetCurrentSea() == "Second Sea" then
                    -- Kiểm tra đã có Pole chưa
                    local hasPole = false
                    if LocalPlayer.Backpack:FindFirstChild("Pole") or LocalPlayer.Character:FindFirstChild("Pole") then
                        hasPole = true
                    end
                    
                    if not hasPole then
                        -- Lấy quest Pole
                        local args = {
                            [1] = "ThunderGod"
                        }
                        game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
                        
                        -- Di chuyển đến Sky Island
                        TweenTo(CFrame.new(-7901.66406, 5606.84619, -2262.43994))
                        
                        -- Tìm và giết quái
                        local mob, distance = GetNearestMob(500)
                        if mob and string.find(mob.Name, "God") and distance < 50 then
                            LocalPlayer.Character.HumanoidRootPart.CFrame = mob.HumanoidRootPart.CFrame * CFrame.new(0, 0, 5)
                            UseFastAttack()
                            UseSkills()
                        end
                    end
                end
            end)
            wait(0.1)
        end
    end)
end

-- ============================================
-- SEA EVENT FUNCTIONS
-- ============================================

function StartAutoFarmShip()
    spawn(function()
        while Config.AutoFarmShip do
            pcall(function()
                -- Tìm ship
                local ship = nil
                for _, v in pairs(Workspace:GetChildren()) do
                    if string.find(v.Name, "Ship") and v:FindFirstChild("Ship") then
                        ship = v
                        break
                    end
                end
                
                if ship then
                    -- Di chuyển đến ship
                    local distance = (LocalPlayer.Character.HumanoidRootPart.Position - ship.Ship.Position).Magnitude
                    if distance > 100 then
                        TweenTo(ship.Ship.CFrame * CFrame.new(0, 0, 50))
                    else
                        -- Tấn công ship
                        LocalPlayer.Character.HumanoidRootPart.CFrame = ship.Ship.CFrame * CFrame.new(0, 0, 20)
                        
                        -- Sử dụng skill tấn công từ xa nếu có
                        UseSkills()
                        
                        -- Kích hoạt haki
                        if Config.AutoBuso then
                            local args = {
                                [1] = "Buso"
                            }
                            game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
                        end
                    end
                else
                    -- Di chuyển đến khu vực thường có ship
                    if GetCurrentSea() == "Third Sea" then
                        TweenTo(CFrame.new(-9542.45703, 21.7500038, 5887.07568))
                    end
                end
            end)
            wait(0.1)
        end
    end)
end

function StartAutoFarmChest()
    spawn(function()
        while Config.AutoFarmChest do
            pcall(function()
                -- Tìm chest gần nhất
                local chest, distance = GetNearestChest(5000)
                
                if chest then
                    if distance > 100 then
                        -- Di chuyển đến chest
                        TweenTo(chest.Chest.CFrame)
                    else
                        -- Mở chest
                        firetouchinterest(LocalPlayer.Character.HumanoidRootPart, chest.Chest, 0)
                        firetouchinterest(LocalPlayer.Character.HumanoidRootPart, chest.Chest, 1)
                    end
                else
                    -- Di chuyển đến các vị trí spawn chest phổ biến
                    SearchForChests()
                end
            end)
            wait(0.1)
        end
    end)
end

function SearchForChests()
    local sea = GetCurrentSea()
    local positions = {}
    
    if sea == "First Sea" then
        positions = {
            CFrame.new(-11.3116875, 29.2767334, 2771.52246),
            CFrame.new(1550.1825, 88.7577744, 290.210938),
            CFrame.new(-1324.24243, 32.5872917, 5258.78809)
        }
    elseif sea == "Second Sea" then
        positions = {
            CFrame.new(-643.150024, 16.2112637, 1487.53418),
            CFrame.new(1443.41162, 88.7577744, 1488.87915),
            CFrame.new(-746.224976, 20.6345444, 2582.28271)
        }
    else
        positions = {
            CFrame.new(-9542.45703, 21.7500038, 5887.07568),
            CFrame.new(-6508.55811, 89.0819931, -132.839172),
            CFrame.new(4481.55371, 8.98999977, 4114.44531)
        }
    end
    
    -- Di chuyển đến các vị trí
    local randomPos = positions[math.random(1, #positions)]
    TweenTo(randomPos)
end

function StartAutoCollectChest()
    spawn(function()
        while Config.AutoCollectChest do
            pcall(function()
                -- Tìm tất cả chest trong phạm vi
                for _, v in pairs(Workspace:GetChildren()) do
                    if string.find(v.Name, "Chest") and v:FindFirstChild("Chest") then
                        local distance = (LocalPlayer.Character.HumanoidRootPart.Position - v.Chest.Position).Magnitude
                        if distance <= 100 then
                            -- Di chuyển đến chest
                            LocalPlayer.Character.HumanoidRootPart.CFrame = v.Chest.CFrame
                            wait(0.5)
                            
                            -- Mở chest
                            firetouchinterest(LocalPlayer.Character.HumanoidRootPart, v.Chest, 0)
                            firetouchinterest(LocalPlayer.Character.HumanoidRootPart, v.Chest, 1)
                        end
                    end
                end
            end)
            wait(1)
        end
    end)
end

-- ============================================
-- MELEE FUNCTIONS
-- ============================================

function StartAutoSuperhuman()
    spawn(function()
        while Config.AutoSuperhuman do
            pcall(function()
                local meleeLevel = LocalPlayer.Data.Stats.Melee.Level.Value
                if meleeLevel >= 300 then
                    -- Kiểm tra đã có Superhuman chưa
                    local hasSuperhuman = false
                    for _, v in pairs(LocalPlayer.Backpack:GetChildren()) do
                        if v.Name == "Superhuman" then
                            hasSuperhuman = true
                            break
                        end
                    end
                    
                    if not hasSuperhuman then
                        -- Mua Superhuman
                        local args = {
                            [1] = "BuySuperhuman"
                        }
                        game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
                    else
                        -- Đã có, trang bị
                        EquipWeapon("Superhuman")
                    end
                else
                    -- Farm melee level
                    StartAutoFarmLevel()
                end
            end)
            wait(1)
        end
    end)
end

function StartAutoDeathStep()
    spawn(function()
        while Config.AutoDeathStep do
            pcall(function()
                if GetCurrentSea() == "Second Sea" then
                    -- Kiểm tra điều kiện mua Death Step
                    local meleeLevel = LocalPlayer.Data.Stats.Melee.Level.Value
                    if meleeLevel >= 400 then
                        -- Mua Death Step
                        local args = {
                            [1] = "BuyDeathStep"
                        }
                        game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
                    end
                end
            end)
            wait(1)
        end
    end)
end

-- ============================================
-- SWORD FUNCTIONS
-- ============================================

function StartAutoBuyLegendarySword()
    spawn(function()
        while Config.AutoBuyLegendarySword do
            pcall(function()
                local swordLevel = LocalPlayer.Data.Stats.Sword.Level.Value
                if swordLevel >= 300 then
                    -- Mua kiếm huyền thoại
                    local args = {
                        [1] = "LegendarySwordDealer",
                        [2] = "1"
                    }
                    game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
                    
                    local args2 = {
                        [1] = "LegendarySwordDealer",
                        [2] = "2"
                    }
                    game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args2))
                end
            end)
            wait(5)
        end
    end)
end

function StartAutoFarmSwordMastery()
    spawn(function()
        while Config.AutoFarmSwordMastery do
            pcall(function()
                if Config.SelectedMasteryWeapon == "" then
                    return
                end
                
                -- Trang bị vũ khí
                EquipWeapon(Config.SelectedMasteryWeapon)
                
                -- Tìm và giết quái
                local mob, distance = GetNearestMob(500)
                if mob and distance < 50 then
                    LocalPlayer.Character.HumanoidRootPart.CFrame = mob.HumanoidRootPart.CFrame * CFrame.new(0, 0, 5)
                    UseFastAttack()
                    UseSkills()
                else
                    -- Di chuyển đến khu vực có quái
                    local spawnLocation = GetMobSpawnLocationForMastery()
                    if spawnLocation then
                        TweenTo(spawnLocation)
                    end
                end
            end)
            wait(0.1)
        end
    end)
end

function GetMobSpawnLocationForMastery()
    local level = GetPlayerLevel()
    if level < 50 then
        return CFrame.new(-886.162292, 73.0200958, 5686.49268)
    elseif level < 100 then
        return CFrame.new(-1580.50696, 36.8527222, 1539.229)
    elseif level < 150 then
        return CFrame.new(-2345.32886, 71.9440079, 2557.29834)
    else
        return CFrame.new(-5324.98389, 440.875, 4084.1355)
    end
end

-- ============================================
-- FRUIT FUNCTIONS
-- ============================================

function StartAutoRandomFruit()
    spawn(function()
        while Config.AutoRandomFruit do
            pcall(function()
                local beli = GetBeli()
                if beli >= 1000000 then
                    -- Mua fruit ngẫu nhiên
                    local args = {
                        [1] = "Cousin",
                        [2] = "Buy"
                    }
                    game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
                else
                    -- Farm beli
                    StartAutoFarmLevel()
                end
            end)
            wait(5)
        end
    end)
end

function StartAutoStoreAllFruit()
    spawn(function()
        while Config.AutoStoreAllFruit do
            pcall(function()
                -- Store tất cả fruit
                local args = {
                    [1] = "StoreFruit",
                    [2] = "All"
                }
                game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
            end)
            wait(10)
        end
    end)
end

function StartAutoSellAllFruit()
    spawn(function()
        while Config.AutoSellAllFruit do
            pcall(function()
                -- Bán tất cả fruit
                local fruits = GetFruitInInventory()
                for _, fruit in pairs(fruits) do
                    local args = {
                        [1] = "SellFruit",
                        [2] = fruit.Name
                    }
                    game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
                end
            end)
            wait(10)
        end
    end)
end

-- ============================================
-- SERVER FUNCTIONS
-- ============================================

function ServerHop()
    pcall(function()
        local Http = game:GetService("HttpService")
        local TPS = game:GetService("TeleportService")
        local API = "https://games.roblox.com/v1/games/%s/servers/Public?sortOrder=%s&limit=%s"
        
        local function GetServers(PlaceId, SortOrder, Limit)
            return Http:JSONDecode(game:HttpGet(string.format(API, PlaceId, SortOrder, Limit)))
        end
        
        local function Hop()
            local servers = GetServers(game.PlaceId, "Desc", 100)
            for _, server in pairs(servers.data) do
                if server.playing < server.maxPlayers and server.id ~= game.JobId then
                    TPS:TeleportToPlaceInstance(game.PlaceId, server.id, LocalPlayer)
                    break
                end
            end
        end
        
        Hop()
    end)
end

function StartAutoHop()
    spawn(function()
        while Config.AutoHop do
            wait(Config.HopAfterTime)
            if Config.AutoHop then
                ServerHop()
            end
        end
    end)
end

-- ============================================
-- PERFORMANCE FUNCTIONS
-- ============================================

function DisableDamageAnimation()
    if Config.DisableDamageAnimation then
        pcall(function()
            LocalPlayer.PlayerScripts.Effects:Destroy()
        end)
    end
end

function RemoveEffect()
    if Config.RemoveEffect then
        pcall(function()
            for _, v in pairs(Workspace:GetDescendants()) do
                if v:IsA("ParticleEmitter") or v:IsA("Trail") then
                    v:Destroy()
                end
            end
        end)
    end
end

function EnableWhiteScreen()
    if Config.WhiteScreen then
        pcall(function()
            local screenGui = Instance.new("ScreenGui")
            screenGui.Name = "WhiteScreen"
            screenGui.Parent = game.CoreGui
            
            local frame = Instance.new("Frame")
            frame.Size = UDim2.new(1, 0, 1, 0)
            frame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
            frame.Parent = screenGui
        end)
    else
        pcall(function()
            local screenGui = game.CoreGui:FindFirstChild("WhiteScreen")
            if screenGui then
                screenGui:Destroy()
            end
        end)
    end
end

function EnableFPSBoost()
    if Config.AutoFPSBoost then
        pcall(function()
            -- Giảm chất lượng đồ họa
            settings().Rendering.QualityLevel = 1
            
            -- Tắt các hiệu ứng không cần thiết
            Lighting.GlobalShadows = false
            Lighting.FogEnd = 100000
            Lighting.Brightness = 2
            
            for _, v in pairs(game:GetDescendants()) do
                if v:IsA("Part") or v:IsA("UnionOperation") or v:IsA("MeshPart") then
                    v.Material = Enum.Material.Plastic
                    v.Reflectance = 0
                elseif v:IsA("Decal") then
                    v.Transparency = 1
                elseif v:IsA("ParticleEmitter") or v:IsA("Trail") then
                    v.Lifetime = NumberRange.new(0)
                end
            end
        end)
    end
end

function SetLowGraphics()
    if Config.AutoGraphics then
        pcall(function()
            for _, v in pairs(Lighting:GetChildren()) do
                if v:IsA("BloomEffect") or v:IsA("BlurEffect") or v:IsA("ColorCorrectionEffect") then
                    v.Enabled = false
                end
            end
        end)
    end
end

function EnableAntiAFK()
    if Config.AntiAFK then
        local VirtualUser = game:GetService("VirtualUser")
        game:GetService("Players").LocalPlayer.Idled:Connect(function()
            VirtualUser:Button2Down(Vector2.new(0,0), Workspace.CurrentCamera.CFrame)
            wait(1)
            VirtualUser:Button2Up(Vector2.new(0,0), Workspace.CurrentCamera.CFrame)
        end)
    end
end

-- ============================================
-- MOVEMENT FUNCTIONS
-- ============================================

local flyToggled = false
local flyBodyVelocity

function EnableFly()
    if Config.Fly and not flyToggled then
        pcall(function()
            local chr = LocalPlayer.Character
            if chr and chr:FindFirstChild("HumanoidRootPart") then
                flyToggled = true
                
                flyBodyVelocity = Instance.new("BodyVelocity")
                flyBodyVelocity.MaxForce = Vector3.new(40000, 40000, 40000)
                flyBodyVelocity.Velocity = Vector3.new(0, 0, 0)
                flyBodyVelocity.Parent = chr.HumanoidRootPart
                
                spawn(function()
                    while flyToggled do
                        local cam = Workspace.CurrentCamera.CFrame
                        local moveX = 0
                        local moveY = 0
                        local moveZ = 0
                        
                        if game:GetService("UserInputService"):IsKeyDown(Enum.KeyCode.W) then
                            moveZ = moveZ - 1
                        end
                        if game:GetService("UserInputService"):IsKeyDown(Enum.KeyCode.S) then
                            moveZ = moveZ + 1
                        end
                        if game:GetService("UserInputService"):IsKeyDown(Enum.KeyCode.A) then
                            moveX = moveX - 1
                        end
                        if game:GetService("UserInputService"):IsKeyDown(Enum.KeyCode.D) then
                            moveX = moveX + 1
                        end
                        if game:GetService("UserInputService"):IsKeyDown(Enum.KeyCode.Space) then
                            moveY = moveY + 1
                        end
                        if game:GetService("UserInputService"):IsKeyDown(Enum.KeyCode.LeftShift) then
                            moveY = moveY - 1
                        end
                        
                        local newVelocity = (cam.LookVector * moveZ + cam.RightVector * moveX + Vector3.new(0, moveY, 0)).Unit * Config.FlySpeed
                        flyBodyVelocity.Velocity = newVelocity
                        
                        wait()
                    end
                end)
            end
        end)
    end
end

function DisableFly()
    flyToggled = false
    if flyBodyVelocity then
        flyBodyVelocity:Destroy()
    end
end

local noclipToggled = false
local noclipConnection

function EnableNoClip()
    if Config.NoClip and not noclipToggled then
        pcall(function()
            noclipToggled = true
            noclipConnection = game:GetService("RunService").Stepped:Connect(function()
                if noclipToggled and LocalPlayer.Character then
                    for _, v in pairs(LocalPlayer.Character:GetDescendants()) do
                        if v:IsA("BasePart") then
                            v.CanCollide = false
                        end
                    end
                end
            end)
        end)
    end
end

function DisableNoClip()
    noclipToggled = false
    if noclipConnection then
        noclipConnection:Disconnect()
    end
end

function EnableWalkOnWater()
    if Config.WalkOnWater then
        pcall(function()
            local chr = LocalPlayer.Character
            if chr and chr:FindFirstChild("HumanoidRootPart") then
                local waterPart = Instance.new("Part")
                waterPart.Size = Vector3.new(100, 1, 100)
                waterPart.Transparency = 0.5
                waterPart.Anchored = true
                waterPart.CanCollide = true
                waterPart.Parent = Workspace
                
                spawn(function()
                    while Config.WalkOnWater do
                        waterPart.CFrame = chr.HumanoidRootPart.CFrame * CFrame.new(0, -5, 0)
                        wait()
                    end
                    waterPart:Destroy()
                end)
            end
        end)
    end
end

function EnableInfEnergy()
    if Config.InfEnergy then
        pcall(function()
            LocalPlayer.Character.Humanoid:GetPropertyChangedSignal("Health"):Connect(function()
                if LocalPlayer.Character.Humanoid.Health < LocalPlayer.Character.Humanoid.MaxHealth then
                    LocalPlayer.Character.Humanoid.Health = LocalPlayer.Character.Humanoid.MaxHealth
                end
            end)
        end)
    end
end

-- ============================================
-- MISC FUNCTIONS
-- ============================================

function StartAutoClick()
    spawn(function()
        while Config.AutoClick do
            pcall(function()
                local VirtualUser = game:GetService("VirtualUser")
                VirtualUser:ClickButton1(Vector2.new(0, 0))
            end)
            wait(1 / Config.AutoClickSpeed)
        end
    end)
end

function ShowHitbox()
    if Config.ShowHitbox then
        pcall(function()
            for _, v in pairs(Workspace.Enemies:GetChildren()) do
                if v:FindFirstChild("HumanoidRootPart") then
                    local box = Instance.new("SelectionBox")
                    box.Adornee = v.HumanoidRootPart
                    box.Color3 = Color3.fromRGB(255, 0, 0)
                    box.Parent = v.HumanoidRootPart
                end
            end
        end)
    else
        pcall(function()
            for _, v in pairs(Workspace.Enemies:GetChildren()) do
                if v.HumanoidRootPart:FindFirstChild("SelectionBox") then
                    v.HumanoidRootPart.SelectionBox:Destroy()
                end
            end
        end)
    end
end

-- ============================================
-- WEBHOOK FUNCTIONS
-- ============================================

function SendWebhook(data)
    if Config.Webhook and Config.WebhookUrl ~= "" then
        pcall(function()
            local http = game:GetService("HttpService")
            local headers = {
                ["Content-Type"] = "application/json"
            }
            
            local payload = {
                ["content"] = data.message or "",
                ["embeds"] = data.embeds or {},
                ["username"] = "Astra X Hub",
                ["avatar_url"] = "https://cdn.discordapp.com/attachments/123456789012345678/123456789012345678/astra_logo.png"
            }
            
            local success, response = pcall(function()
                return http:PostAsync(Config.WebhookUrl, http:JSONEncode(payload), Enum.HttpContentType.ApplicationJson)
            end)
            
            if not success then
                -- Xử lý lỗi
            end
        end)
    end
end

function StartAutoSendStats()
    spawn(function()
        while Config.AutoSendStats do
            local level = GetPlayerLevel()
            local beli = GetBeli()
            local fragments = GetFragments()
            local playerCount = #Players:GetPlayers()
            
            local embed = {
                {
                    ["title"] = "📊 Player Statistics",
                    ["color"] = 0x00FFAA,
                    ["fields"] = {
                        {
                            ["name"] = "Level",
                            ["value"] = tostring(level),
                            ["inline"] = true
                        },
                        {
                            ["name"] = "Beli",
                            ["value"] = tostring(beli),
                            ["inline"] = true
                        },
                        {
                            ["name"] = "Fragments",
                            ["value"] = tostring(fragments),
                            ["inline"] = true
                        },
                        {
                            ["name"] = "Server Players",
                            ["value"] = tostring(playerCount),
                            ["inline"] = true
                        }
                    },
                    ["footer"] = {
                        ["text"] = "Astra X Hub | " .. os.date("%Y-%m-%d %H:%M:%S")
                    }
                }
            }
            
            SendWebhook({embeds = embed})
            
            wait(Config.SendStatsInterval)
        end
    end)
end

-- ============================================
-- PLAYER FUNCTIONS
-- ============================================

function StartAutoKillPlayer()
    spawn(function()
        while Config.AutoKillPlayer do
            pcall(function()
                local targetPlayer = Config.SelectedPlayer
                if targetPlayer and targetPlayer ~= "" then
                    local target = Players:FindFirstChild(targetPlayer)
                    if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
                        -- Di chuyển đến người chơi
                        local distance = (LocalPlayer.Character.HumanoidRootPart.Position - target.Character.HumanoidRootPart.Position).Magnitude
                        if distance > 50 then
                            TweenTo(target.Character.HumanoidRootPart.CFrame * CFrame.new(0, 0, 5))
                        else
                            LocalPlayer.Character.HumanoidRootPart.CFrame = target.Character.HumanoidRootPart.CFrame * CFrame.new(0, 0, 5)
                            
                            -- Tấn công dựa trên vũ khí được chọn
                            if Config.AutoKillPlayerMelee then
                                EquipWeapon("Melee")
                                UseFastAttack()
                            elseif Config.AutoKillPlayerSword then
                                EquipWeapon(Config.SelectedMasteryWeapon)
                                UseFastAttack()
                            elseif Config.AutoKillPlayerGun then
                                -- Sử dụng súng
                                local args = {
                                    [1] = "Gun"
                                }
                                game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
                            end
                            
                            UseSkills()
                        end
                    end
                end
            end)
            wait(0.1)
        end
    end)
end

-- ============================================
-- SETTING FUNCTIONS
-- ============================================

function SaveSettings()
    if Config.AutoSaveSetting then
        pcall(function()
            local http = game:GetService("HttpService")
            local data = http:JSONEncode(Config)
            writefile("AstraXHub_" .. Config.SettingName .. ".json", data)
        end)
    end
end

function LoadSettings()
    pcall(function()
        local http = game:GetService("HttpService")
        if isfile("AstraXHub_" .. Config.SettingName .. ".json") then
            local data = readfile("AstraXHub_" .. Config.SettingName .. ".json")
            local loadedConfig = http:JSONDecode(data)
            
            for key, value in pairs(loadedConfig) do
                Config[key] = value
            end
            
            -- Cập nhật UI với cài đặt đã load
            UpdateUIWithConfig()
        end
    end)
end

function UpdateUIWithConfig()
    -- Cập nhật tất cả các toggle và slider với giá trị từ Config
    -- Hàm này sẽ được gọi khi load settings
end

-- ============================================
-- INITIALIZATION
-- ============================================

-- Kích hoạt Anti AFK
if Config.AntiAFK then
    EnableAntiAFK()
end

-- Kích hoạt FPS Boost
if Config.AutoFPSBoost then
    EnableFPSBoost()
end

-- Kích hoạt Low Graphics
if Config.AutoGraphics then
    SetLowGraphics()
end

-- Tự động load settings khi bắt đầu
if Config.LoadSetting then
    LoadSettings()
end

-- Auto save settings định kỳ
spawn(function()
    while true do
        wait(30)
        if Config.AutoSaveSetting then
            SaveSettings()
        end
    end
end)

-- Thông báo script đã sẵn sàng
Rayfield:Notify({
    Title = "Astra X Hub",
    Content = "Kaitun Leviathan Script loaded successfully!",
    Duration = 5,
    Image = nil
})
-- Phần 3: Hệ thống Leviathan chuyên sâu

-- ============================================
-- LEVIATHAN CONFIGURATION
-- ============================================

local LeviathanConfig = {
    AutoSpawnLeviathan = false,
    AutoCallLeviathan = false,
    AutoSummonLeviathan = false,
    UseBoat = true,
    BoatType = "Basic",
    UseCannon = true,
    AimForHead = true,
    AvoidTidalWave = true,
    UseGodMode = false,
    LeviathanSpawnMethod = "Auto",
    SpawnLocation = "Default",
    UseSkillsOnLeviathan = true,
    UseRockets = false,
    AutoDodge = true,
    UseAnchor = false,
    FarmLeviathanOnly = true,
    StopIfLowHealth = true,
    MinHealthPercent = 30,
    UseHealthPots = true,
    HealthPotPercent = 50,
    LeviathanPriority = "Highest",
    TargetWeakSpot = true,
    WeakSpot = "Head",
    UseBoatSkills = true,
    BoatSkillInterval = 5,
    LeviathanSearchRange = 5000,
    AutoLeaveIfNoLeviathan = false,
    WaitTimeForLeviathan = 300,
    HopIfNoLeviathan = false,
    AutoBuyCannonBalls = true,
    CannonBallAmount = 100,
    UseSpecialAttack = true,
    SpecialAttackType = "Rocket",
    AutoLoot = true,
    LootPriority = "Leviathan Scale",
    AutoStoreLoot = true,
    SellJunkItems = true,
    KeepScale = true,
    ScaleAmountToKeep = 100,
    AutoTideCheck = true,
    TideCheckInterval = 10,
    NotifyOnTideChange = true,
    UseTidePrediction = true,
    TidePredictionMethod = "Advanced"
}

-- ============================================
-- LEVIATHAN SPAWN SYSTEM
-- ============================================

local LeviathanData = {
    SpawnLocations = {
        ["ThirdSea"] = {
            CFrame.new(-9542.45703, 21.7500038, 5887.07568),
            CFrame.new(-10234.5811, 234.282227, -10144.041),
            CFrame.new(-12133.5518, 405.925903, -12255.125)
        }
    },
    SpawnConditions = {
        TideLevel = 3, -- Mức thủy triều
        TimeOfDay = "Any",
        PlayerCount = 1,
        RequiredItems = {},
        Weather = "Clear"
    },
    WeakSpots = {
        "Head",
        "Neck",
        "Chest",
        "Tail"
    },
    AttackPatterns = {
        "TidalWave",
        "Bite",
        "TailSwipe",
        "WaterBlast"
    },
    LootTable = {
        "Leviathan Scale",
        "Leviathan Tooth",
        "Leviathan Heart",
        "Leviathan Fin",
        "Leviathan Crown",
        "Leviathan Essence"
    }
}

function CheckLeviathanSpawnConditions()
    local canSpawn = true
    local reasons = {}
    
    -- Kiểm tra thủy triều
    local tideCycle = Workspace:FindFirstChild("TideCycle")
    if tideCycle then
        local tideValue = tideCycle.Value or 0
        if tideValue < LeviathanData.SpawnConditions.TideLevel then
            canSpawn = false
            table.insert(reasons, "Tide too low: " .. tideValue .. "/" .. LeviathanData.SpawnConditions.TideLevel)
        end
    else
        canSpawn = false
        table.insert(reasons, "No tide cycle found")
    end
    
    -- Kiểm tra số lượng người chơi
    local playerCount = #Players:GetPlayers()
    if playerCount < LeviathanData.SpawnConditions.PlayerCount then
        canSpawn = false
        table.insert(reasons, "Not enough players: " .. playerCount .. "/" .. LeviathanData.SpawnConditions.PlayerCount)
    end
    
    -- Kiểm tra vật phẩm cần thiết
    for _, item in pairs(LeviathanData.SpawnConditions.RequiredItems) do
        local hasItem = CheckIfHasItem(item)
        if not hasItem then
            canSpawn = false
            table.insert(reasons, "Missing item: " .. item)
        end
    end
    
    return canSpawn, reasons
end

function SpawnLeviathan()
    if not Config.AutoLeviathan then return end
    
    local canSpawn, reasons = CheckLeviathanSpawnConditions()
    
    if canSpawn then
        -- Gọi Leviathan
        local args = {
            [1] = "Leviathan",
            [2] = "Summon"
        }
        game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
        
        -- Thông báo
        if Config.NotifyWhenBoss then
            SendNotification("Leviathan đã được triệu hồi!")
        end
        
        return true
    else
        -- Hiển thị lý do không thể spawn
        if Config.NotifyWhenError then
            SendNotification("Không thể triệu hồi Leviathan: " .. table.concat(reasons, ", "))
        end
        return false
    end
end

function CheckIfHasItem(itemName)
    local hasItem = false
    pcall(function()
        -- Kiểm tra trong backpack
        for _, v in pairs(LocalPlayer.Backpack:GetChildren()) do
            if v.Name == itemName then
                hasItem = true
                return
            end
        end
        
        -- Kiểm tra trong character
        if LocalPlayer.Character then
            for _, v in pairs(LocalPlayer.Character:GetChildren()) do
                if v.Name == itemName then
                    hasItem = true
                    return
                end
            end
        end
        
        -- Kiểm tra trong data
        if LocalPlayer.Data:FindFirstChild(itemName) then
            hasItem = LocalPlayer.Data[itemName].Value > 0
        end
    end)
    return hasItem
end

-- ============================================
-- LEVIATHAN COMBAT SYSTEM
-- ============================================

local LeviathanCombat = {
    CurrentLeviathan = nil,
    AttackCooldown = 0,
    LastAttackTime = 0,
    AttackPattern = 1,
    CurrentWeakSpot = "Head",
    BoatHealth = 100,
    CannonCooldown = 0,
    LastCannonTime = 0,
    RocketCount = 10,
    SpecialAttackReady = true,
    SpecialAttackCooldown = 30,
    LastSpecialAttackTime = 0
}

function FindLeviathan()
    local leviathan = nil
    local distance = math.huge
    
    -- Tìm trong Bosses trước
    pcall(function()
        for _, v in pairs(Workspace.Bosses:GetChildren()) do
            if string.find(v.Name, "Leviathan") then
                local dist = (LocalPlayer.Character.HumanoidRootPart.Position - v.HumanoidRootPart.Position).Magnitude
                if dist < distance then
                    distance = dist
                    leviathan = v
                end
            end
        end
        
        -- Nếu không tìm thấy, tìm trong Enemies
        if not leviathan then
            for _, v in pairs(Workspace.Enemies:GetChildren()) do
                if string.find(v.Name, "Leviathan") then
                    local dist = (LocalPlayer.Character.HumanoidRootPart.Position - v.HumanoidRootPart.Position).Magnitude
                    if dist < distance then
                        distance = dist
                        leviathan = v
                    end
                end
            end
        end
        
        -- Tìm trong SeaBeasts (đôi khi Leviathan ở đây)
        if not leviathan then
            for _, v in pairs(Workspace:GetChildren()) do
                if string.find(v.Name, "Leviathan") or string.find(v.Name, "SeaBeast") then
                    if v:FindFirstChild("HumanoidRootPart") then
                        local dist = (LocalPlayer.Character.HumanoidRootPart.Position - v.HumanoidRootPart.Position).Magnitude
                        if dist < distance then
                            distance = dist
                            leviathan = v
                        end
                    end
                end
            end
        end
    end)
    
    return leviathan, distance
end

function AttackLeviathan(leviathan)
    if not leviathan or not leviathan:FindFirstChild("Humanoid") or leviathan.Humanoid.Health <= 0 then
        return
    end
    
    local currentTime = tick()
    
    -- Kiểm tra cooldown tấn công
    if currentTime - LeviathanCombat.LastAttackTime < LeviathanCombat.AttackCooldown then
        return
    end
    
    -- Xác định vị trí yếu
    local weakSpot = GetLeviathanWeakSpot(leviathan)
    
    -- Di chuyển đến vị trí tấn công tối ưu
    MoveToAttackPosition(leviathan, weakSpot)
    
    -- Sử dụng tấn công thường
    if Config.UseSkillsOnLeviathan then
        UseSkills()
    end
    
    -- Sử dụng Fast Attack
    if Config.FastAttack then
        UseFastAttack()
    end
    
    -- Sử dụng súng thần công nếu có
    if LeviathanConfig.UseCannon and currentTime - LeviathanCombat.LastCannonTime > 2 then
        UseCannon(leviathan, weakSpot)
        LeviathanCombat.LastCannonTime = currentTime
    end
    
    -- Sử dụng rocket nếu có
    if LeviathanConfig.UseRockets and LeviathanCombat.RocketCount > 0 then
        if currentTime - LeviathanCombat.LastSpecialAttackTime > 5 then
            UseRocket(leviathan, weakSpot)
            LeviathanCombat.RocketCount = LeviathanCombat.RocketCount - 1
            LeviathanCombat.LastSpecialAttackTime = currentTime
        end
    end
    
    -- Sử dụng tấn công đặc biệt
    if LeviathanConfig.UseSpecialAttack and LeviathanCombat.SpecialAttackReady then
        UseSpecialAttack(leviathan, weakSpot)
        LeviathanCombat.SpecialAttackReady = false
        spawn(function()
            wait(LeviathanCombat.SpecialAttackCooldown)
            LeviathanCombat.SpecialAttackReady = true
        end)
    end
    
    -- Tránh tấn công của Leviathan
    if LeviathanConfig.AutoDodge then
        DodgeLeviathanAttack(leviathan)
    end
    
    LeviathanCombat.LastAttackTime = currentTime
end

function GetLeviathanWeakSpot(leviathan)
    if not LeviathanConfig.TargetWeakSpot then
        return "HumanoidRootPart"
    end
    
    local weakSpot = LeviathanConfig.WeakSpot
    
    -- Tìm part yếu nhất
    if leviathan:FindFirstChild(weakSpot) then
        return weakSpot
    end
    
    -- Nếu không tìm thấy, tìm part khác
    for _, spot in pairs(LeviathanData.WeakSpots) do
        if leviathan:FindFirstChild(spot) then
            return spot
        end
    end
    
    -- Mặc định
    return "HumanoidRootPart"
end

function MoveToAttackPosition(leviathan, weakSpot)
    if not leviathan:FindFirstChild(weakSpot) then
        return
    end
    
    local weakSpotPart = leviathan[weakSpot]
    local safeDistance = 50 -- Khoảng cách an toàn
    
    -- Tính toán vị trí tấn công tối ưu
    local attackPosition = weakSpotPart.CFrame * CFrame.new(0, 0, safeDistance)
    
    -- Nếu đang trên thuyền, điều chỉnh vị trí
    if LeviathanConfig.UseBoat then
        attackPosition = weakSpotPart.CFrame * CFrame.new(0, 20, 80)
    end
    
    -- Di chuyển đến vị trí
    if (LocalPlayer.Character.HumanoidRootPart.Position - attackPosition.Position).Magnitude > 10 then
        if LeviathanConfig.UseBoat then
            MoveBoatTo(attackPosition)
        else
            TweenTo(attackPosition)
        end
    end
end

function UseCannon(leviathan, targetPart)
    if not leviathan or not targetPart then return end
    
    pcall(function()
        -- Kích hoạt súng thần công
        local args = {
            [1] = "Cannon",
            [2] = "Fire",
            [3] = targetPart.Position
        }
        game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
        
        -- Mua đạn nếu hết
        if LeviathanConfig.AutoBuyCannonBalls then
            CheckAndBuyCannonBalls()
        end
    end)
end

function UseRocket(leviathan, targetPart)
    if not leviathan or not targetPart then return end
    
    pcall(function()
        -- Sử dụng rocket
        local args = {
            [1] = "Rocket",
            [2] = "Fire",
            [3] = targetPart.Position
        }
        game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
    end)
end

function UseSpecialAttack(leviathan, targetPart)
    if not leviathan or not targetPart then return end
    
    pcall(function()
        local attackType = LeviathanConfig.SpecialAttackType
        
        if attackType == "Rocket" then
            -- Tấn công rocket mạnh
            for i = 1, 3 do
                UseRocket(leviathan, targetPart)
                wait(0.2)
            end
        elseif attackType == "CannonBarrage" then
            -- Barrage súng thần công
            for i = 1, 5 do
                UseCannon(leviathan, targetPart)
                wait(0.1)
            end
        elseif attackType == "SwordCombo" then
            -- Combo kiếm
            EquipWeapon(Config.SelectedMasteryWeapon)
            for i = 1, 10 do
                UseFastAttack()
                wait(0.05)
            end
        end
    end)
end

function DodgeLeviathanAttack(leviathan)
    if not leviathan then return end
    
    pcall(function()
        -- Kiểm tra nếu Leviathan đang tấn công
        local animator = leviathan.Humanoid:FindFirstChild("Animator")
        if animator then
            -- Phát hiện animation tấn công
            for _, track in pairs(animator:GetPlayingAnimationTracks()) do
                if track.Name:find("Attack") or track.Name:find("Swipe") or track.Name:find("Wave") then
                    -- Di chuyển tránh né
                    local dodgeDirection = CalculateDodgeDirection(leviathan)
                    LocalPlayer.Character.HumanoidRootPart.CFrame = LocalPlayer.Character.HumanoidRootPart.CFrame * dodgeDirection
                    return
                end
            end
        end
        
        -- Phát hiện sóng thần
        if LeviathanConfig.AvoidTidalWave then
            AvoidTidalWave(leviathan)
        end
    end)
end

function CalculateDodgeDirection(leviathan)
    local direction = CFrame.new(0, 0, 0)
    
    -- Tính toán hướng tránh né dựa trên vị trí Leviathan
    local toLeviathan = (leviathan.HumanoidRootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).Unit
    
    -- Tránh sang bên phải
    local rightVector = LocalPlayer.Character.HumanoidRootPart.CFrame.RightVector
    direction = CFrame.new(rightVector * 20)
    
    -- Thêm độ cao nếu cần
    direction = direction * CFrame.new(0, 10, 0)
    
    return direction
end

function AvoidTidalWave(leviathan)
    -- Kiểm tra sóng thần
    for _, v in pairs(Workspace:GetChildren()) do
        if v.Name:find("Tidal") or v.Name:find("Wave") then
            -- Di chuyển lên cao
            LocalPlayer.Character.HumanoidRootPart.CFrame = LocalPlayer.Character.HumanoidRootPart.CFrame * CFrame.new(0, 50, 0)
            return true
        end
    end
    return false
end

-- ============================================
-- BOAT SYSTEM FOR LEVIATHAN
-- ============================================

local BoatSystem = {
    CurrentBoat = nil,
    BoatHealth = 100,
    BoatSpeed = 50,
    BoatTurning = 1,
    CannonLoaded = true,
    AnchorDropped = false,
    BoatSkills = {},
    BoatSkillCooldowns = {}
}

function GetBoat()
    local boat = nil
    
    pcall(function()
        -- Tìm thuyền của người chơi
        for _, v in pairs(Workspace:GetChildren()) do
            if v.Name:find("Boat") and v:FindFirstChild("Seat") then
                -- Kiểm tra xem có phải thuyền của người chơi không
                if v:FindFirstChild("Owner") and v.Owner.Value == LocalPlayer then
                    boat = v
                    break
                end
            end
        end
        
        -- Nếu không tìm thấy, tìm thuyền gần nhất
        if not boat then
            local closestDistance = math.huge
            for _, v in pairs(Workspace:GetChildren()) do
                if v.Name:find("Boat") and v:FindFirstChild("Seat") then
                    local distance = (LocalPlayer.Character.HumanoidRootPart.Position - v.Seat.Position).Magnitude
                    if distance < closestDistance then
                        closestDistance = distance
                        boat = v
                    end
                end
            end
        end
    end)
    
    return boat
end

function EnterBoat()
    if not LeviathanConfig.UseBoat then return false end
    
    local boat = GetBoat()
    if boat and boat:FindFirstChild("Seat") then
        -- Lên thuyền
        LocalPlayer.Character.Humanoid.Sit = true
        LocalPlayer.Character.HumanoidRootPart.CFrame = boat.Seat.CFrame
        BoatSystem.CurrentBoat = boat
        return true
    else
        -- Mua thuyền nếu không có
        if BuyBoat(LeviathanConfig.BoatType) then
            wait(2)
            return EnterBoat()
        end
        return false
    end
end

function BuyBoat(boatType)
    pcall(function()
        local args = {
            [1] = "BuyBoat",
            [2] = boatType
        }
        game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
        return true
    end)
    return false
end

function MoveBoatTo(position)
    if not BoatSystem.CurrentBoat then return end
    
    pcall(function()
        -- Di chuyển thuyền đến vị trí
        local boat = BoatSystem.CurrentBoat
        if boat:FindFirstChild("VehicleSeat") then
            -- Tính toán hướng
            local direction = (position.Position - boat.VehicleSeat.Position).Unit
            
            -- Áp dụng lực đẩy
            if boat:FindFirstChild("BodyVelocity") then
                boat.BodyVelocity.Velocity = direction * BoatSystem.BoatSpeed
            else
                local bv = Instance.new("BodyVelocity")
                bv.Velocity = direction * BoatSystem.BoatSpeed
                bv.MaxForce = Vector3.new(100000, 100000, 100000)
                bv.P = 10000
                bv.Parent = boat
            end
            
            -- Xoay thuyền
            boat.VehicleSeat.CFrame = CFrame.lookAt(boat.VehicleSeat.Position, position.Position)
        end
    end)
end

function UseBoatSkill(skillName)
    if not BoatSystem.CurrentBoat then return end
    
    pcall(function()
        -- Kiểm tra cooldown
        local currentTime = tick()
        if BoatSystem.BoatSkillCooldowns[skillName] and 
           currentTime - BoatSystem.BoatSkillCooldowns[skillName] < 10 then
            return
        end
        
        -- Sử dụng skill
        local args = {
            [1] = "BoatSkill",
            [2] = skillName
        }
        game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
        
        BoatSystem.BoatSkillCooldowns[skillName] = currentTime
    end)
end

-- ============================================
-- LOOT SYSTEM FOR LEVIATHAN
-- ============================================

function CollectLeviathanLoot()
    if not LeviathanConfig.AutoLoot then return end
    
    pcall(function()
        -- Tìm loot của Leviathan
        for _, v in pairs(Workspace:GetChildren()) do
            if v.Name:find("Leviathan") and v:FindFirstChild("Drop") then
                local drop = v.Drop
                
                -- Thu thập tất cả loot
                for _, item in pairs(drop:GetChildren()) do
                    CollectItem(item)
                end
            end
        end
        
        -- Tìm loot rơi trên mặt nước
        for _, v in pairs(Workspace:GetChildren()) do
            if v.Name:find("Drop") or v.Name:find("Loot") then
                local distance = (LocalPlayer.Character.HumanoidRootPart.Position - v.Position).Magnitude
                if distance < 50 then
                    CollectItem(v)
                end
            end
        end
    end)
end

function CollectItem(item)
    pcall(function()
        -- Di chuyển đến item
        LocalPlayer.Character.HumanoidRootPart.CFrame = item.CFrame
        
        -- Thu thập item
        firetouchinterest(LocalPlayer.Character.HumanoidRootPart, item, 0)
        firetouchinterest(LocalPlayer.Character.HumanoidRootPart, item, 1)
        
        -- Xử lý item
        ProcessLootItem(item.Name)
    end)
end

function ProcessLootItem(itemName)
    -- Kiểm tra xem có phải là vảy Leviathan không
    if itemName:find("Leviathan Scale") then
        if LeviathanConfig.KeepScale then
            -- Kiểm tra số lượng
            local scaleCount = GetItemCount("Leviathan Scale")
            if scaleCount >= LeviathanConfig.ScaleAmountToKeep then
                -- Bán bớt nếu quá nhiều
                if LeviathanConfig.SellJunkItems then
                    SellExcessScales(scaleCount - LeviathanConfig.ScaleAmountToKeep)
                end
            end
        end
    end
    
    -- Lưu trữ nếu cần
    if LeviathanConfig.AutoStoreLoot then
        StoreItem(itemName)
    end
end

function GetItemCount(itemName)
    local count = 0
    pcall(function()
        if LocalPlayer.Data:FindFirstChild(itemName) then
            count = LocalPlayer.Data[itemName].Value
        end
    end)
    return count
end

function StoreItem(itemName)
    pcall(function()
        local args = {
            [1] = "StoreItem",
            [2] = itemName
        }
        game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
    end)
end

function SellExcessScales(amount)
    if amount <= 0 then return end
    
    pcall(function()
        local args = {
            [1] = "SellItem",
            [2] = "Leviathan Scale",
            [3] = amount
        }
        game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
    end)
end

-- ============================================
-- TIDE SYSTEM FOR LEVIATHAN SPAWN
-- ============================================

local TideSystem = {
    CurrentTide = 0,
    TideCheckInterval = 10,
    LastTideCheck = 0,
    TidePrediction = {},
    TideHistory = {}
}

function CheckTide()
    local currentTime = tick()
    
    if currentTime - TideSystem.LastTideCheck < TideSystem.TideCheckInterval then
        return TideSystem.CurrentTide
    end
    
    pcall(function()
        local tideCycle = Workspace:FindFirstChild("TideCycle")
        if tideCycle then
            TideSystem.CurrentTide = tideCycle.Value or 0
            
            -- Lưu lịch sử
            table.insert(TideSystem.TideHistory, {
                Time = currentTime,
                Tide = TideSystem.CurrentTide
            })
            
            -- Giữ lại 100 bản ghi gần nhất
            if #TideSystem.TideHistory > 100 then
                table.remove(TideSystem.TideHistory, 1)
            end
            
            -- Dự đoán thủy triều
            if LeviathanConfig.UseTidePrediction then
                PredictNextTide()
            end
            
            TideSystem.LastTideCheck = currentTime
            
            -- Thông báo nếu thủy triều cao
            if LeviathanConfig.NotifyOnTideChange and TideSystem.CurrentTide >= 3 then
                if Config.NotifyWhenBoss then
                    SendNotification("Thủy triều cao! Leviathan có thể xuất hiện!")
                end
            end
        end
    end)
    
    return TideSystem.CurrentTide
end

function PredictNextTide()
    if #TideSystem.TideHistory < 10 then return end
    
    -- Phân tích lịch sử để dự đoán
    local method = LeviathanConfig.TidePredictionMethod
    
    if method == "Simple" then
        -- Dự đoán đơn giản: lấy giá trị trung bình
        local sum = 0
        for _, record in pairs(TideSystem.TideHistory) do
            sum = sum + record.Tide
        end
        TideSystem.TidePrediction.NextTide = sum / #TideSystem.TideHistory
        TideSystem.TidePrediction.Time = tick() + 300 -- 5 phút sau
    elseif method == "Advanced" then
        -- Dự đoán nâng cao: phân tích chu kỳ
        AnalyzeTidePattern()
    end
end

function AnalyzeTidePattern()
    -- Phân tích mẫu thủy triều
    local pattern = {}
    local lastTide = TideSystem.TideHistory[#TideSystem.TideHistory].Tide
    
    -- Tìm chu kỳ
    for i = #TideSystem.TideHistory - 1, 1, -1 do
        if TideSystem.TideHistory[i].Tide >= 3 then
            local timeDiff = TideSystem.TideHistory[#TideSystem.TideHistory].Time - TideSystem.TideHistory[i].Time
            if timeDiff > 600 then -- 10 phút
                TideSystem.TidePrediction.NextHighTide = tick() + timeDiff
                break
            end
        end
    end
end

function GetTimeUntilHighTide()
    if TideSystem.TidePrediction.NextHighTide then
        local timeUntil = TideSystem.TidePrediction.NextHighTide - tick()
        return math.max(0, timeUntil)
    end
    return 0
end

-- ============================================
-- LEVIATHAN MAIN LOOP
-- ============================================

function LeviathanMainLoop()
    spawn(function()
        while Config.AutoLeviathan do
            -- Kiểm tra thủy triều
            CheckTide()
            
            -- Tìm Leviathan
            local leviathan, distance = FindLeviathan()
            
            if leviathan then
                -- Cập nhật Leviathan hiện tại
                LeviathanCombat.CurrentLeviathan = leviathan
                
                -- Vào thuyền nếu cần
                if LeviathanConfig.UseBoat and not BoatSystem.CurrentBoat then
                    EnterBoat()
                end
                
                -- Tấn công Leviathan
                AttackLeviathan(leviathan)
                
                -- Thu thập loot nếu Leviathan chết
                if leviathan.Humanoid.Health <= 0 then
                    CollectLeviathanLoot()
                    wait(2)
                end
            else
                -- Không tìm thấy Leviathan
                LeviathanCombat.CurrentLeviathan = nil
                
                -- Kiểm tra điều kiện spawn
                local canSpawn = CheckLeviathanSpawnConditions()
                
                if canSpawn and LeviathanConfig.AutoSpawnLeviathan then
                    -- Thử spawn Leviathan
                    SpawnLeviathan()
                else
                    -- Chờ đợi hoặc di chuyển
                    if LeviathanConfig.AutoLeaveIfNoLeviathan then
                        local waitTime = LeviathanConfig.WaitTimeForLeviathan
                        if waitTime > 0 then
                            wait(waitTime)
                            if not FindLeviathan() then
                                if LeviathanConfig.HopIfNoLeviathan then
                                    ServerHop()
                                end
                            end
                        end
                    end
                end
            end
            
            -- Kiểm tra máu người chơi
            CheckPlayerHealth()
            
            wait(0.1)
        end
    end)
end

function CheckPlayerHealth()
    if not LeviathanConfig.StopIfLowHealth then return end
    
    local character = LocalPlayer.Character
    if character and character:FindFirstChild("Humanoid") then
        local healthPercent = (character.Humanoid.Health / character.Humanoid.MaxHealth) * 100
        
        if healthPercent < LeviathanConfig.MinHealthPercent then
            -- Dừng tấn công và chạy
            Config.AutoLeviathan = false
            
            -- Sử dụng đồ hồi máu
            if LeviathanConfig.UseHealthPots and healthPercent < LeviathanConfig.HealthPotPercent then
                UseHealthPotion()
            end
            
            -- Di chuyển đến nơi an toàn
            MoveToSafeLocation()
            
            -- Thông báo
            if Config.NotifyWhenError then
                SendNotification("Máu thấp! Đã dừng farm Leviathan!")
            end
        end
    end
end

function UseHealthPotion()
    pcall(function()
        local args = {
            [1] = "UsePotion",
            [2] = "Health"
        }
        game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
    end)
end

function MoveToSafeLocation()
    -- Di chuyển đến đảo gần nhất
    local safeLocations = {
        CFrame.new(-9542.45703, 100, 5887.07568), -- Trên cao
        CFrame.new(-8500, 50, 5000), -- Đảo gần đó
        CFrame.new(-9000, 200, 6000) -- Trên trời
    }
    
    local randomLoc = safeLocations[math.random(1, #safeLocations)]
    TweenTo(randomLoc)
end

-- ============================================
-- NOTIFICATION SYSTEM
-- ============================================

function SendNotification(message)
    -- Gửi thông báo trong game
    Rayfield:Notify({
        Title = "Leviathan System",
        Content = message,
        Duration = 5,
        Image = nil
    })
    
    -- Gửi webhook nếu có
    if Config.Webhook and Config.WebhookUrl ~= "" then
        SendWebhook({
            embeds = {{
                title = "Leviathan Notification",
                description = message,
                color = 0x00FFAA,
                timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ"),
                footer = {
                    text = "Astra X Hub"
                }
            }}
        })
    end
end

-- ============================================
-- GUI ADDITIONS FOR LEVIATHAN
-- ============================================

-- Thêm tab Leviathan chuyên sâu
local LeviathanTab = Window:CreateTab("Leviathan", nil)

-- Section: Leviathan Control
local LeviathanControlSection = LeviathanTab:CreateSection("Leviathan Control")
local AutoSpawnLeviathanToggle = LeviathanTab:CreateToggle({
    Name = "Auto Spawn Leviathan",
    CurrentValue = LeviathanConfig.AutoSpawnLeviathan,
    Flag = "AutoSpawnLeviathan",
    Callback = function(Value)
        LeviathanConfig.AutoSpawnLeviathan = Value
    end
})

local UseBoatToggle = LeviathanTab:CreateToggle({
    Name = "Use Boat",
    CurrentValue = LeviathanConfig.UseBoat,
    Flag = "UseBoat",
    Callback = function(Value)
        LeviathanConfig.UseBoat = Value
    end
})

local BoatTypeDropdown = LeviathanTab:CreateDropdown({
    Name = "Boat Type",
    Options = {"Basic", "Fast", "War", "Leviathan Hunter"},
    CurrentOption = LeviathanConfig.BoatType,
    Flag = "BoatType",
    Callback = function(Option)
        LeviathanConfig.BoatType = Option
    end
})

local UseCannonToggle = LeviathanTab:CreateToggle({
    Name = "Use Cannon",
    CurrentValue = LeviathanConfig.UseCannon,
    Flag = "UseCannon",
    Callback = function(Value)
        LeviathanConfig.UseCannon = Value
    end
})

local AutoBuyCannonBallsToggle = LeviathanTab:CreateToggle({
    Name = "Auto Buy Cannon Balls",
    CurrentValue = LeviathanConfig.AutoBuyCannonBalls,
    Flag = "AutoBuyCannonBalls",
    Callback = function(Value)
        LeviathanConfig.AutoBuyCannonBalls = Value
    end
})

local CannonBallAmountSlider = LeviathanTab:CreateSlider({
    Name = "Cannon Ball Amount",
    Range = {10, 500},
    Increment = 10,
    Suffix = "Balls",
    CurrentValue = LeviathanConfig.CannonBallAmount,
    Flag = "CannonBallAmount",
    Callback = function(Value)
        LeviathanConfig.CannonBallAmount = Value
    end
})

-- Section: Combat Settings
local LeviathanCombatSection = LeviathanTab:CreateSection("Combat Settings")
local TargetWeakSpotToggle = LeviathanTab:CreateToggle({
    Name = "Target Weak Spot",
    CurrentValue = LeviathanConfig.TargetWeakSpot,
    Flag = "TargetWeakSpot",
    Callback = function(Value)
        LeviathanConfig.TargetWeakSpot = Value
    end
})

local WeakSpotDropdown = LeviathanTab:CreateDropdown({
    Name = "Weak Spot",
    Options = LeviathanData.WeakSpots,
    CurrentOption = LeviathanConfig.WeakSpot,
    Flag = "WeakSpot",
    Callback = function(Option)
        LeviathanConfig.WeakSpot = Option
    end
})

local UseSkillsToggle = LeviathanTab:CreateToggle({
    Name = "Use Skills on Leviathan",
    CurrentValue = LeviathanConfig.UseSkillsOnLeviathan,
    Flag = "UseSkillsOnLeviathan",
    Callback = function(Value)
        LeviathanConfig.UseSkillsOnLeviathan = Value
    end
})

local UseRocketsToggle = LeviathanTab:CreateToggle({
    Name = "Use Rockets",
    CurrentValue = LeviathanConfig.UseRockets,
    Flag = "UseRockets",
    Callback = function(Value)
        LeviathanConfig.UseRockets = Value
    end
})

local AutoDodgeToggle = LeviathanTab:CreateToggle({
    Name = "Auto Dodge Attacks",
    CurrentValue = LeviathanConfig.AutoDodge,
    Flag = "AutoDodge",
    Callback = function(Value)
        LeviathanConfig.AutoDodge = Value
    end
})

local AvoidTidalWaveToggle = LeviathanTab:CreateToggle({
    Name = "Avoid Tidal Wave",
    CurrentValue = LeviathanConfig.AvoidTidalWave,
    Flag = "AvoidTidalWave",
    Callback = function(Value)
        LeviathanConfig.AvoidTidalWave = Value
    end
})

-- Section: Safety Settings
local SafetySection = LeviathanTab:CreateSection("Safety Settings")
local StopIfLowHealthToggle = LeviathanTab:CreateToggle({
    Name = "Stop If Low Health",
    CurrentValue = LeviathanConfig.StopIfLowHealth,
    Flag = "StopIfLowHealth",
    Callback = function(Value)
        LeviathanConfig.StopIfLowHealth = Value
    end
})

local MinHealthPercentSlider = LeviathanTab:CreateSlider({
    Name = "Min Health Percent",
    Range = {10, 90},
    Increment = 5,
    Suffix = "%",
    CurrentValue = LeviathanConfig.MinHealthPercent,
    Flag = "MinHealthPercent",
    Callback = function(Value)
        LeviathanConfig.MinHealthPercent = Value
    end
})

local UseHealthPotsToggle = LeviathanTab:CreateToggle({
    Name = "Use Health Potions",
    CurrentValue = LeviathanConfig.UseHealthPots,
    Flag = "UseHealthPots",
    Callback = function(Value)
        LeviathanConfig.UseHealthPots = Value
    end
})

local HealthPotPercentSlider = LeviathanTab:CreateSlider({
    Name = "Health Potion Percent",
    Range = {20, 80},
    Increment = 5,
    Suffix = "%",
    CurrentValue = LeviathanConfig.HealthPotPercent,
    Flag = "HealthPotPercent",
    Callback = function(Value)
        LeviathanConfig.HealthPotPercent = Value
    end
})

-- Section: Loot Settings
local LootSection = LeviathanTab:CreateSection("Loot Settings")
local AutoLootToggle = LeviathanTab:CreateToggle({
    Name = "Auto Loot",
    CurrentValue = LeviathanConfig.AutoLoot,
    Flag = "AutoLoot",
    Callback = function(Value)
        LeviathanConfig.AutoLoot = Value
    end
})

local AutoStoreLootToggle = LeviathanTab:CreateToggle({
    Name = "Auto Store Loot",
    CurrentValue = LeviathanConfig.AutoStoreLoot,
    Flag = "AutoStoreLoot",
    Callback = function(Value)
        LeviathanConfig.AutoStoreLoot = Value
    end
})

local SellJunkItemsToggle = LeviathanTab:CreateToggle({
    Name = "Sell Junk Items",
    CurrentValue = LeviathanConfig.SellJunkItems,
    Flag = "SellJunkItems",
    Callback = function(Value)
        LeviathanConfig.SellJunkItems = Value
    end
})

local KeepScaleToggle = LeviathanTab:CreateToggle({
    Name = "Keep Leviathan Scales",
    CurrentValue = LeviathanConfig.KeepScale,
    Flag = "KeepScale",
    Callback = function(Value)
        LeviathanConfig.KeepScale = Value
    end
})

local ScaleAmountSlider = LeviathanTab:CreateSlider({
    Name = "Scale Amount to Keep",
    Range = {10, 1000},
    Increment = 10,
    Suffix = "Scales",
    CurrentValue = LeviathanConfig.ScaleAmountToKeep,
    Flag = "ScaleAmountToKeep",
    Callback = function(Value)
        LeviathanConfig.ScaleAmountToKeep = Value
    end
})

-- Section: Tide System
local TideSection = LeviathanTab:CreateSection("Tide System")
local AutoTideCheckToggle = LeviathanTab:CreateToggle({
    Name = "Auto Tide Check",
    CurrentValue = LeviathanConfig.AutoTideCheck,
    Flag = "AutoTideCheck",
    Callback = function(Value)
        LeviathanConfig.AutoTideCheck = Value
    end
})

local TideCheckIntervalSlider = LeviathanTab:CreateSlider({
    Name = "Tide Check Interval",
    Range = {5, 60},
    Increment = 5,
    Suffix = "Seconds",
    CurrentValue = LeviathanConfig.TideCheckInterval,
    Flag = "TideCheckInterval",
    Callback = function(Value)
        LeviathanConfig.TideCheckInterval = Value
    end
})

local NotifyOnTideChangeToggle = LeviathanTab:CreateToggle({
    Name = "Notify on Tide Change",
    CurrentValue = LeviathanConfig.NotifyOnTideChange,
    Flag = "NotifyOnTideChange",
    Callback = function(Value)
        LeviathanConfig.NotifyOnTideChange = Value
    end
})

local UseTidePredictionToggle = LeviathanTab:CreateToggle({
    Name = "Use Tide Prediction",
    CurrentValue = LeviathanConfig.UseTidePrediction,
    Flag = "UseTidePrediction",
    Callback = function(Value)
        LeviathanConfig.UseTidePrediction = Value
    end
})

local TidePredictionDropdown = LeviathanTab:CreateDropdown({
    Name = "Tide Prediction Method",
    Options = {"Simple", "Advanced"},
    CurrentOption = LeviathanConfig.TidePredictionMethod,
    Flag = "TidePredictionMethod",
    Callback = function(Option)
        LeviathanConfig.TidePredictionMethod = Option
    end
})

-- Section: Server Control
local ServerControlSection = LeviathanTab:CreateSection("Server Control")
local AutoLeaveIfNoLeviathanToggle = LeviathanTab:CreateToggle({
    Name = "Auto Leave If No Leviathan",
    CurrentValue = LeviathanConfig.AutoLeaveIfNoLeviathan,
    Flag = "AutoLeaveIfNoLeviathan",
    Callback = function(Value)
        LeviathanConfig.AutoLeaveIfNoLeviathan = Value
    end
})

local WaitTimeForLeviathanSlider = LeviathanTab:CreateSlider({
    Name = "Wait Time for Leviathan",
    Range = {60, 1800},
    Increment = 30,
    Suffix = "Seconds",
    CurrentValue = LeviathanConfig.WaitTimeForLeviathan,
    Flag = "WaitTimeForLeviathan",
    Callback = function(Value)
        LeviathanConfig.WaitTimeForLeviathan = Value
    end
})

local HopIfNoLeviathanToggle = LeviathanTab:CreateToggle({
    Name = "Hop If No Leviathan",
    CurrentValue = LeviathanConfig.HopIfNoLeviathan,
    Flag = "HopIfNoLeviathan",
    Callback = function(Value)
        LeviathanConfig.HopIfNoLeviathan = Value
    end
})

-- Buttons
local LeviathanButtonsSection = LeviathanTab:CreateSection("Actions")
local StartLeviathanButton = LeviathanTab:CreateButton({
    Name = "Start Leviathan Farm",
    Callback = function()
        Config.AutoLeviathan = true
        LeviathanMainLoop()
        SendNotification("Bắt đầu farm Leviathan!")
    end
})

local StopLeviathanButton = LeviathanTab:CreateButton({
    Name = "Stop Leviathan Farm",
    Callback = function()
        Config.AutoLeviathan = false
        SendNotification("Đã dừng farm Leviathan!")
    end
})

local ForceSpawnButton = LeviathanTab:CreateButton({
    Name = "Force Spawn Leviathan",
    Callback = function()
        SpawnLeviathan()
    end
})

local CheckTideButton = LeviathanTab:CreateButton({
    Name = "Check Tide Now",
    Callback = function()
        local tide = CheckTide()
        SendNotification("Thủy triều hiện tại: " .. tide)
    end
})

-- ============================================
-- START LEVIATHAN SYSTEM
-- ============================================

-- Khởi động hệ thống khi bật Auto Leviathan
if Config.AutoLeviathan then
    LeviathanMainLoop()
end

-- Auto mua cannon balls
if LeviathanConfig.AutoBuyCannonBalls then
    spawn(function()
        while true do
            wait(30)
            if Config.AutoLeviathan then
                CheckAndBuyCannonBalls()
            end
        end
    end)
end

-- Auto kiểm tra thủy triều
if LeviathanConfig.AutoTideCheck then
    spawn(function()
        while true do
            wait(LeviathanConfig.TideCheckInterval)
            CheckTide()
        end
    end)
end

SendNotification("Leviathan System đã sẵn sàng!")
-- Phần 4: Tối ưu hiệu suất & Hoàn thiện Leviathan

-- ============================================
-- PERFORMANCE OPTIMIZATION SYSTEM
-- ============================================

local Performance = {
    FPS = 60,
    Ping = 0,
    MemoryUsage = 0,
    LastOptimization = 0,
    OptimizationInterval = 300, -- 5 phút
    GraphicsQuality = 1,
    DisabledEffects = {},
    ReducedParticles = false,
    MinimalMode = false,
    CacheSystem = {},
    LastCacheClear = 0,
    CacheClearInterval = 600 -- 10 phút
}

function OptimizePerformance()
    if Performance.LastOptimization > 0 and tick() - Performance.LastOptimization < Performance.OptimizationInterval then
        return
    end
    
    pcall(function()
        -- Giảm chất lượng đồ họa
        settings().Rendering.QualityLevel = Performance.GraphicsQuality
        
        -- Tắt shadow
        Lighting.GlobalShadows = false
        Lighting.ShadowSoftness = 0
        
        -- Giảm fog
        Lighting.FogEnd = 100000
        Lighting.FogStart = 99999
        
        -- Tắt các effect không cần thiết
        for _, effect in pairs(Lighting:GetChildren()) do
            if effect:IsA("PostEffect") or effect:IsA("Atmosphere") then
                effect.Enabled = false
                table.insert(Performance.DisabledEffects, effect.Name)
            end
        end
        
        -- Giảm particle
        if Performance.ReducedParticles then
            for _, v in pairs(Workspace:GetDescendants()) do
                if v:IsA("ParticleEmitter") then
                    v.Rate = math.floor(v.Rate / 2)
                    v.Lifetime = NumberRange.new(math.max(0.5, v.Lifetime.Min), math.max(1, v.Lifetime.Max))
                end
            end
        end
        
        -- Mode tối giản
        if Performance.MinimalMode then
            -- Tắt decal
            for _, v in pairs(Workspace:GetDescendants()) do
                if v:IsA("Decal") then
                    v.Transparency = 1
                end
            end
            
            -- Giảm mesh detail
            for _, v in pairs(Workspace:GetDescendants()) do
                if v:IsA("MeshPart") then
                    v.RenderFidelity = Enum.RenderFidelity.Performance
                end
            end
        end
        
        -- Xóa cache cũ
        ClearOldCache()
        
        Performance.LastOptimization = tick()
        
        if Config.NotifyWhenDone then
            SendNotification("Đã tối ưu hiệu suất! FPS: " .. GetFPS())
        end
    end)
end

function GetFPS()
    local fps = 60
    pcall(function()
        fps = math.floor(1 / game:GetService("RunService").RenderStepped:Wait())
    end)
    Performance.FPS = fps
    return fps
end

function GetPing()
    local ping = 0
    pcall(function()
        ping = math.floor(game:GetService("Stats").Network.ServerStatsItem["Data Ping"]:GetValue())
    end)
    Performance.Ping = ping
    return ping
end

function MonitorPerformance()
    spawn(function()
        while true do
            wait(5)
            
            -- Kiểm tra FPS
            local fps = GetFPS()
            local ping = GetPing()
            
            -- Nếu FPS thấp, tối ưu hóa
            if fps < 30 and tick() - Performance.LastOptimization > 60 then
                OptimizePerformance()
            end
            
            -- Nếu ping cao, cảnh báo
            if ping > 300 and Config.NotifyWhenError then
                SendNotification("Ping cao: " .. ping .. "ms - Có thể ảnh hưởng đến farm Leviathan!")
            end
            
            -- Kiểm tra memory
            CheckMemoryUsage()
        end
    end)
end

function CheckMemoryUsage()
    pcall(function()
        local memory = game:GetService("Stats"):GetTotalMemoryUsageMb()
        Performance.MemoryUsage = memory
        
        if memory > 500 then -- Nếu sử dụng hơn 500MB
            ClearMemory()
        end
    end)
end

function ClearMemory()
    pcall(function()
        -- Force garbage collection
        for i = 1, 10 do
            wait()
            game:GetService("RunService"):Heartbeat()
        end
        
        collectgarbage()
        collectgarbage()
        
        if Config.NotifyWhenDone then
            SendNotification("Đã dọn dẹp bộ nhớ! Memory: " .. math.floor(Performance.MemoryUsage) .. "MB")
        end
    end)
end

function ClearOldCache()
    if tick() - Performance.LastCacheClear < Performance.CacheClearInterval then
        return
    end
    
    pcall(function()
        -- Xóa cache cũ
        Performance.CacheSystem = {}
        
        -- Xóa các instance không cần thiết
        for _, v in pairs(game:GetService("CoreGui"):GetChildren()) do
            if v.Name:find("_Cache") or v.Name:find("_Temp") then
                v:Destroy()
            end
        end
        
        Performance.LastCacheClear = tick()
    end)
end

-- ============================================
-- ANTI-BAN SYSTEM FOR LEVIATHAN
-- ============================================

local AntiBan = {
    HumanLikeActions = true,
    RandomDelays = true,
    ActionHistory = {},
    LastActionTime = 0,
    ActionPatterns = {},
    SafetyChecks = true,
    MaxActionsPerMinute = 120,
    ActionCount = 0,
    LastResetTime = 0,
    DetectionAvoidance = true,
    MimicHumanBehavior = true,
    RandomMovements = true,
    AntiTeleportDetection = true,
    AntiSpeedHackDetection = true,
    AntiAutoClickDetection = true
}

function InitializeAntiBan()
    -- Thiết lập pattern hành vi ngẫu nhiên
    AntiBan.ActionPatterns = {
        {"Attack", "Move", "Pause", "Attack", "Move", "Turn"},
        {"Move", "Pause", "Attack", "Turn", "Attack", "Move"},
        {"Pause", "Attack", "Move", "Attack", "Turn", "Pause"}
    }
    
    -- Bắt đầu reset counter mỗi phút
    spawn(function()
        while true do
            wait(60)
            AntiBan.ActionCount = 0
            AntiBan.LastResetTime = tick()
        end
    end)
    
    -- Thêm delay ngẫu nhiên
    if AntiBan.RandomDelays then
        math.randomseed(tick())
    end
end

function PerformHumanLikeAction(actionType, ...)
    if not AntiBan.HumanLikeActions then
        return PerformAction(actionType, ...)
    end
    
    -- Kiểm tra rate limit
    if AntiBan.ActionCount >= AntiBan.MaxActionsPerMinute then
        local waitTime = 60 - (tick() - AntiBan.LastResetTime)
        if waitTime > 0 then
            HumanWait(waitTime)
            AntiBan.ActionCount = 0
        end
    end
    
    -- Thêm delay ngẫu nhiên giữa các hành động
    if AntiBan.RandomDelays then
        local randomDelay = math.random(50, 300) / 1000 -- 0.05 đến 0.3 giây
        HumanWait(randomDelay)
    end
    
    -- Chọn pattern ngẫu nhiên
    local pattern = AntiBan.ActionPatterns[math.random(1, #AntiBan.ActionPatterns)]
    local currentPatternIndex = 1
    
    -- Thêm hành động vào lịch sử
    table.insert(AntiBan.ActionHistory, {
        Time = tick(),
        Action = actionType,
        Pattern = pattern
    })
    
    -- Giới hạn lịch sử
    if #AntiBan.ActionHistory > 100 then
        table.remove(AntiBan.ActionHistory, 1)
    end
    
    AntiBan.ActionCount = AntiBan.ActionCount + 1
    AntiBan.LastActionTime = tick()
    
    -- Thực hiện hành động
    return PerformAction(actionType, ...)
end

function PerformAction(actionType, ...)
    local args = {...}
    
    pcall(function()
        if actionType == "Attack" then
            UseFastAttack()
        elseif actionType == "Move" then
            local position = args[1]
            TweenTo(position)
        elseif actionType == "Turn" then
            -- Xoay người ngẫu nhiên
            LocalPlayer.Character.HumanoidRootPart.CFrame = LocalPlayer.Character.HumanoidRootPart.CFrame * CFrame.Angles(0, math.rad(math.random(-45, 45)), 0)
        elseif actionType == "Pause" then
            -- Dừng lại và "quan sát"
            HumanWait(math.random(1, 3))
        end
    end)
end

function HumanWait(seconds)
    -- Chờ đợi theo cách "con người" với biến động nhỏ
    local jitter = math.random(80, 120) / 100 -- 0.8 đến 1.2
    wait(seconds * jitter)
end

function AvoidDetection()
    if not AntiBan.DetectionAvoidance then return end
    
    -- Tránh phát hiện teleport
    if AntiBan.AntiTeleportDetection then
        AvoidTeleportDetection()
    end
    
    -- Tránh phát hiện speed hack
    if AntiBan.AntiSpeedHackDetection then
        AvoidSpeedHackDetection()
    end
    
    -- Tránh phát hiện auto click
    if AntiBan.AntiAutoClickDetection then
        AvoidAutoClickDetection()
    end
end

function AvoidTeleportDetection()
    -- Giới hạn tốc độ di chuyển
    local maxSpeed = 300 -- studs/giây
    local currentSpeed = (LocalPlayer.Character.HumanoidRootPart.Velocity).Magnitude
    
    if currentSpeed > maxSpeed then
        -- Giảm tốc độ
        LocalPlayer.Character.Humanoid.WalkSpeed = math.min(LocalPlayer.Character.Humanoid.WalkSpeed, 100)
        
        -- Thêm delay
        HumanWait(1)
    end
end

function AvoidSpeedHackDetection()
    -- Giới hạn thay đổi tốc độ
    local walkSpeed = LocalPlayer.Character.Humanoid.WalkSpeed
    if walkSpeed > 200 then
        -- Giảm tốc độ từ từ
        for i = walkSpeed, 100, -10 do
            LocalPlayer.Character.Humanoid.WalkSpeed = i
            wait(0.1)
        end
    end
end

function AvoidAutoClickDetection()
    -- Thay đổi pattern click
    if Config.AutoClick then
        local clickPatterns = {
            {0.1, 0.2, 0.1, 0.3, 0.1},
            {0.2, 0.1, 0.2, 0.1, 0.2},
            {0.15, 0.15, 0.15, 0.15, 0.15}
        }
        
        local pattern = clickPatterns[math.random(1, #clickPatterns)]
        for _, delay in ipairs(pattern) do
            VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 0)
            VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 0)
            wait(delay)
        end
    end
end

function MimicHumanBehavior()
    if not AntiBan.MimicHumanBehavior then return end
    
    spawn(function()
        while true do
            wait(math.random(30, 120)) -- Mỗi 30-120 giây
            
            -- Thực hiện hành động "con người" ngẫu nhiên
            local randomAction = math.random(1, 10)
            
            if randomAction == 1 then
                -- "Nhìn xung quanh"
                PerformHumanLikeAction("Turn")
            elseif randomAction == 2 then
                -- "Nghỉ ngơi"
                PerformHumanLikeAction("Pause")
            elseif randomAction == 3 and AntiBan.RandomMovements then
                -- Di chuyển ngẫu nhiên nhẹ
                local randomOffset = Vector3.new(
                    math.random(-10, 10),
                    0,
                    math.random(-10, 10)
                )
                local newPosition = LocalPlayer.Character.HumanoidRootPart.Position + randomOffset
                PerformHumanLikeAction("Move", CFrame.new(newPosition))
            end
        end
    end)
end

-- ============================================
-- STATISTICS TRACKING SYSTEM
-- ============================================

local Statistics = {
    SessionStart = tick(),
    LeviathanKilled = 0,
    TotalDamage = 0,
    TotalLoot = {},
    TimeSpent = 0,
    DeathCount = 0,
    BoatUsed = 0,
    CannonBallsUsed = 0,
    RocketsUsed = 0,
    HealthPotionsUsed = 0,
    SessionRecords = {},
    BestTime = math.huge,
    WorstTime = 0,
    AverageTime = 0,
    Efficiency = 0
}

function InitializeStatistics()
    Statistics.TotalLoot = {
        ["Leviathan Scale"] = 0,
        ["Leviathan Tooth"] = 0,
        ["Leviathan Heart"] = 0,
        ["Leviathan Fin"] = 0,
        ["Leviathan Crown"] = 0,
        ["Leviathan Essence"] = 0
    }
    
    -- Lưu thống kê mỗi 5 phút
    spawn(function()
        while true do
            wait(300)
            SaveStatistics()
        end
    end)
end

function RecordLeviathanKill(killTime)
    Statistics.LeviathanKilled = Statistics.LeviathanKilled + 1
    Statistics.TimeSpent = tick() - Statistics.SessionStart
    
    -- Ghi lại thời gian
    table.insert(Statistics.SessionRecords, {
        Time = tick(),
        KillTime = killTime,
        Damage = Statistics.TotalDamage,
        Loot = Statistics.TotalLoot
    })
    
    -- Cập nhật kỷ lục
    if killTime < Statistics.BestTime then
        Statistics.BestTime = killTime
    end
    
    if killTime > Statistics.WorstTime then
        Statistics.WorstTime = killTime
    end
    
    -- Tính thời gian trung bình
    local totalTime = 0
    for _, record in ipairs(Statistics.SessionRecords) do
        totalTime = totalTime + record.KillTime
    end
    Statistics.AverageTime = totalTime / #Statistics.SessionRecords
    
    -- Tính hiệu suất
    Statistics.Efficiency = (Statistics.LeviathanKilled / (Statistics.TimeSpent / 3600)) -- Số Leviathan/giờ
    
    -- Gửi thông báo
    if Config.AutoNotify then
        SendStatisticsNotification()
    end
end

function RecordDamage(damage)
    Statistics.TotalDamage = Statistics.TotalDamage + damage
end

function RecordLoot(itemName, amount)
    if Statistics.TotalLoot[itemName] then
        Statistics.TotalLoot[itemName] = Statistics.TotalLoot[itemName] + amount
    else
        Statistics.TotalLoot[itemName] = amount
    end
end

function RecordBoatUse()
    Statistics.BoatUsed = Statistics.BoatUsed + 1
end

function RecordCannonBallUse()
    Statistics.CannonBallsUsed = Statistics.CannonBallsUsed + 1
end

function RecordRocketUse()
    Statistics.RocketsUsed = Statistics.RocketsUsed + 1
end

function RecordHealthPotionUse()
    Statistics.HealthPotionsUsed = Statistics.HealthPotionsUsed + 1
end

function RecordDeath()
    Statistics.DeathCount = Statistics.DeathCount + 1
end

function GetSessionDuration()
    return tick() - Statistics.SessionStart
end

function FormatTime(seconds)
    local hours = math.floor(seconds / 3600)
    local minutes = math.floor((seconds % 3600) / 60)
    local secs = math.floor(seconds % 60)
    
    return string.format("%02d:%02d:%02d", hours, minutes, secs)
end

function GetStatisticsSummary()
    local summary = {
        SessionDuration = FormatTime(GetSessionDuration()),
        LeviathanKilled = Statistics.LeviathanKilled,
        TotalDamage = Statistics.TotalDamage,
        DeathCount = Statistics.DeathCount,
        Efficiency = string.format("%.2f", Statistics.Efficiency),
        BestTime = string.format("%.1f", Statistics.BestTime) .. "s",
        AverageTime = string.format("%.1f", Statistics.AverageTime) .. "s",
        BoatUsed = Statistics.BoatUsed,
        CannonBallsUsed = Statistics.CannonBallsUsed,
        RocketsUsed = Statistics.RocketsUsed,
        HealthPotionsUsed = Statistics.HealthPotionsUsed
    }
    
    return summary
end

function SaveStatistics()
    pcall(function()
        local data = {
            SessionStart = Statistics.SessionStart,
            SessionEnd = tick(),
            Statistics = Statistics
        }
        
        -- Lưu vào file
        local json = game:GetService("HttpService"):JSONEncode(data)
        writefile("Leviathan_Statistics_" .. os.date("%Y%m%d_%H%M%S") .. ".json", json)
    end)
end

function LoadStatistics()
    pcall(function()
        -- Tìm file thống kê mới nhất
        local files = listfiles("")
        local latestFile = nil
        local latestTime = 0
        
        for _, file in ipairs(files) do
            if file:find("Leviathan_Statistics") then
                local fileTime = file:match("(%d+)_(%d+)_(%d+)%.json")
                if fileTime then
                    if tonumber(fileTime) > latestTime then
                        latestTime = tonumber(fileTime)
                        latestFile = file
                    end
                end
            end
        end
        
        if latestFile then
            local data = game:GetService("HttpService"):JSONDecode(readfile(latestFile))
            Statistics = data.Statistics
            Statistics.SessionStart = tick() -- Reset session
        end
    end)
end

-- ============================================
-- WEBHOOK NOTIFICATION SYSTEM
-- ============================================

local WebhookSystem = {
    Enabled = Config.Webhook,
    URL = Config.WebhookUrl,
    DiscordID = Config.DiscordId,
    LastSent = 0,
    Cooldown = 60, -- 1 phút
    Templates = {},
    EventLog = {}
}

function InitializeWebhookTemplates()
    WebhookSystem.Templates = {
        LeviathanSpawn = {
            title = "🐉 Leviathan Đã Xuất Hiện!",
            color = 0x00FF00,
            fields = {
                {name = "Vị trí", value = "Third Sea", inline = true},
                {name = "Thủy triều", value = "{}", inline = true},
                {name = "Server", value = "{}", inline = true}
            }
        },
        LeviathanKill = {
            title = "🎉 Leviathan Đã Bị Tiêu Diệt!",
            color = 0xFF0000,
            fields = {
                {name = "Thời gian", value = "{} giây", inline = true},
                {name = "Sát thương", value = "{}", inline = true},
                {name = "Loot", value = "{}", inline = true},
                {name = "Tổng số lần", value = "{}", inline = true}
            }
        },
        StatisticsUpdate = {
            title = "📊 Thống Kê Farm Leviathan",
            color = 0x00AAFF,
            fields = {
                {name = "Thời gian farm", value = "{}", inline = true},
                {name = "Số Leviathan", value = "{}", inline = true},
                {name = "Hiệu suất", value = "{}/giờ", inline = true},
                {name = "Tỉ lệ chết", value = "{}%", inline = true}
            }
        },
        ErrorAlert = {
            title = "⚠️ Lỗi Khi Farm Leviathan",
            color = 0xFFAA00,
            fields = {
                {name = "Lỗi", value = "{}", inline = false},
                {name = "Thời gian", value = "{}", inline = true},
                {name = "Vị trí", value = "{}", inline = true}
            }
        }
    }
}

function SendWebhookNotification(templateName, data)
    if not WebhookSystem.Enabled or WebhookSystem.URL == "" then
        return
    end
    
    -- Kiểm tra cooldown
    if tick() - WebhookSystem.LastSent < WebhookSystem.Cooldown then
        return
    end
    
    local template = WebhookSystem.Templates[templateName]
    if not template then
        return
    end
    
    pcall(function()
        local embed = {
            title = template.title,
            color = template.color,
            fields = {},
            timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ"),
            footer = {
                text = "Astra X Hub | Leviathan Farmer"
            }
        }
        
        -- Điền dữ liệu vào fields
        for _, field in ipairs(template.fields) do
            local fieldCopy = {name = field.name, value = field.value, inline = field.inline}
            
            -- Thay thế placeholders
            for i = 1, select("#", unpack(data)) do
                fieldCopy.value = fieldCopy.value:gsub("{}", tostring(select(i, unpack(data))), 1)
            end
            
            table.insert(embed.fields, fieldCopy)
        end
        
        -- Thêm thumbnail nếu có
        if templateName == "LeviathanKill" then
            embed.thumbnail = {
                url = "https://cdn.discordapp.com/attachments/123456789012345678/123456789012345678/leviathan.png"
            }
        end
        
        -- Gửi webhook
        local http = game:GetService("HttpService")
        local payload = {
            content = WebhookSystem.DiscordID and "<@" .. WebhookSystem.DiscordID .. ">" or "",
            embeds = {embed},
            username = "Astra X Hub - Leviathan Farmer",
            avatar_url = "https://cdn.discordapp.com/attachments/123456789012345678/123456789012345678/astra_logo.png"
        }
        
        local success, response = pcall(function()
            return http:PostAsync(WebhookSystem.URL, http:JSONEncode(payload), Enum.HttpContentType.ApplicationJson)
        end)
        
        if success then
            WebhookSystem.LastSent = tick()
            table.insert(WebhookSystem.EventLog, {
                Time = tick(),
                Template = templateName,
                Success = true
            })
        else
            table.insert(WebhookSystem.EventLog, {
                Time = tick(),
                Template = templateName,
                Success = false,
                Error = response
            })
        end
    end)
end

function SendStatisticsNotification()
    local summary = GetStatisticsSummary()
    
    SendWebhookNotification("StatisticsUpdate", {
        summary.SessionDuration,
        summary.LeviathanKilled,
        summary.Efficiency,
        summary.DeathCount > 0 and string.format("%.1f", (summary.DeathCount / summary.LeviathanKilled) * 100) or "0"
    })
end

function SendLeviathanKillNotification(killTime, damage, loot)
    SendWebhookNotification("LeviathanKill", {
        string.format("%.1f", killTime),
        damage,
        loot,
        Statistics.LeviathanKilled
    })
end

function SendErrorNotification(errorMsg, location)
    SendWebhookNotification("ErrorAlert", {
        errorMsg,
        os.date("%H:%M:%S"),
        location or "Unknown"
    })
end

-- ============================================
-- ERROR HANDLING SYSTEM
-- ============================================

local ErrorHandler = {
    ErrorLog = {},
    MaxErrors = 100,
    AutoRestart = true,
    RestartThreshold = 10, -- Số lỗi trước khi restart
    RestartCooldown = 300, -- 5 phút
    LastRestart = 0,
    ErrorTypes = {
        Network = "Network Error",
        Script = "Script Error",
        Game = "Game Error",
        AntiBan = "Anti-Ban Detection"
    }
}

function HandleError(errorType, errorMsg, location)
    local errorData = {
        Time = tick(),
        Type = errorType,
        Message = errorMsg,
        Location = location,
        StackTrace = debug.traceback()
    }
    
    table.insert(ErrorHandler.ErrorLog, errorData)
    
    -- Giới hạn số lỗi lưu trữ
    if #ErrorHandler.ErrorLog > ErrorHandler.MaxErrors then
        table.remove(ErrorHandler.ErrorLog, 1)
    end
    
    -- Log vào console
    print("[ERROR][" .. errorType .. "] " .. errorMsg .. " at " .. location)
    
    -- Gửi webhook nếu là lỗi nghiêm trọng
    if errorType == ErrorHandler.ErrorTypes.AntiBan or errorType == ErrorHandler.ErrorTypes.Game then
        SendErrorNotification(errorMsg, location)
    end
    
    -- Kiểm tra nếu cần restart
    if ErrorHandler.AutoRestart then
        CheckForRestart()
    end
end

function CheckForRestart()
    -- Đếm số lỗi trong 5 phút gần nhất
    local errorCount = 0
    local currentTime = tick()
    
    for _, error in ipairs(ErrorHandler.ErrorLog) do
        if currentTime - error.Time < 300 then -- 5 phút
            errorCount = errorCount + 1
        end
    end
    
    -- Nếu quá nhiều lỗi và đã qua cooldown
    if errorCount >= ErrorHandler.RestartThreshold and 
       currentTime - ErrorHandler.LastRestart > ErrorHandler.RestartCooldown then
        RestartScript()
    end
end

function RestartScript()
    ErrorHandler.LastRestart = tick()
    
    -- Lưu thống kê trước khi restart
    SaveStatistics()
    
    -- Thông báo
    if Config.NotifyWhenError then
        SendNotification("Script đang khởi động lại do quá nhiều lỗi...")
    end
    
    -- Đợi và restart
    wait(3)
    
    -- Tải lại script
    loadstring(game:HttpGet("https://raw.githubusercontent.com/your-repo/leviathan-farm/main.lua"))()
end

function SafeCall(func, ...)
    local args = {...}
    local success, result = pcall(function()
        return func(unpack(args))
    end)
    
    if not success then
        HandleError(ErrorHandler.ErrorTypes.Script, result, debug.traceback())
        return nil
    end
    
    return result
end

-- Wrapper cho tất cả hàm quan trọng
function CreateSafeWrapper(func)
    return function(...)
        return SafeCall(func, ...)
    end
end

-- ============================================
-- LEVIATHAN FARMER INTEGRATION
-- ============================================

-- Tích hợp tất cả hệ thống vào farmer chính
function EnhancedLeviathanFarmer()
    -- Khởi tạo tất cả hệ thống
    InitializeAntiBan()
    InitializeStatistics()
    InitializeWebhookTemplates()
    MonitorPerformance()
    MimicHumanBehavior()
    
    -- Bắt đầu farm
    spawn(function()
        while Config.AutoLeviathan do
            SafeCall(function()
                -- Kiểm tra thủy triều
                local tide = CheckTide()
                
                -- Tìm Leviathan
                local leviathan, distance = FindLeviathan()
                
                if leviathan then
                    -- Bắt đầu combat
                    local startTime = tick()
                    local startHealth = leviathan.Humanoid.Health
                    
                    while leviathan and leviathan.Humanoid.Health > 0 and Config.AutoLeviathan do
                        -- Tấn công với anti-ban
                        PerformHumanLikeAction("Attack")
                        
                        -- Di chuyển với anti-ban
                        if distance > 100 then
                            PerformHumanLikeAction("Move", leviathan.HumanoidRootPart.CFrame * CFrame.new(0, 0, 50))
                        end
                        
                        -- Tránh detection
                        AvoidDetection()
                        
                        -- Cập nhật thống kê
                        local damage = startHealth - leviathan.Humanoid.Health
                        RecordDamage(damage)
                        
                        -- Kiểm tra performance
                        if Performance.FPS < 20 then
                            OptimizePerformance()
                        end
                        
                        wait()
                    end
                    
                    -- Nếu Leviathan chết
                    if leviathan and leviathan.Humanoid.Health <= 0 then
                        local killTime = tick() - startTime
                        local totalDamage = startHealth - leviathan.Humanoid.Health
                        
                        -- Ghi lại kill
                        RecordLeviathanKill(killTime)
                        
                        -- Thu thập loot
                        CollectLeviathanLoot()
                        
                        -- Gửi thông báo
                        if Config.NotifyWhenBoss then
                            SendNotification("Đã tiêu diệt Leviathan trong " .. string.format("%.1f", killTime) .. " giây!")
                            SendLeviathanKillNotification(killTime, totalDamage, "Leviathan Scale")
                        end
                        
                        -- Chờ spawn lại
                        HumanWait(math.random(10, 30))
                    end
                else
                    -- Chờ Leviathan spawn
                    if LeviathanConfig.AutoSpawnLeviathan and tide >= 3 then
                        PerformHumanLikeAction("Pause")
                        SpawnLeviathan()
                    else
                        -- Di chuyển ngẫu nhiên để tránh detection
                        if AntiBan.RandomMovements then
                            local randomPos = LeviathanData.SpawnLocations.ThirdSea[math.random(1, 3)]
                            PerformHumanLikeAction("Move", randomPos)
                        end
                        
                        HumanWait(5)
                    end
                end
            end)
            
            wait(0.1)
        end
    end)
end

-- ============================================
-- GUI OPTIMIZATION TAB
-- ============================================

local OptimizationTab = :CreateTab("⚡ Optimization", nil)

-- Performance Section
local PerformanceSection = OptimizationTab:CreateSection("Performance Settings")
local FPSBoostToggle = OptimizationTab:CreateToggle({
    Name = "FPS Boost",
    CurrentValue = Config.AutoFPSBoost,
    Flag = "AutoFPSBoost",
    Callback = function(Value)
        Config.AutoFPSBoost = Value
        if Value then
            OptimizePerformance()
        end
    end
})

local GraphicsQualitySlider = OptimizationTab:CreateSlider({
    Name = "Graphics Quality",
    Range = {1, 10},
    Increment = 1,
    Suffix = "Level",
    CurrentValue = Performance.GraphicsQuality,
    Flag = "GraphicsQuality",
    Callback = function(Value)
        Performance.GraphicsQuality = Value
        OptimizePerformance()
    end
})

local ReducedParticlesToggle = OptimizationTab:CreateToggle({
    Name = "Reduce Particles",
    CurrentValue = Performance.ReducedParticles,
    Flag = "ReducedParticles",
    Callback = function(Value)
        Performance.ReducedParticles = Value
        OptimizePerformance()
    end
})

local MinimalModeToggle = OptimizationTab:CreateToggle({
    Name = "Minimal Mode",
    CurrentValue = Performance.MinimalMode,
    Flag = "MinimalMode",
    Callback = function(Value)
        Performance.MinimalMode = Value
        OptimizePerformance()
    end
})

local AutoOptimizeToggle = OptimizationTab:CreateToggle({
    Name = "Auto Optimize",
    CurrentValue = true,
    Flag = "AutoOptimize",
    Callback = function(Value)
        if Value then
            spawn(function()
                while Value do
                    wait(Performance.OptimizationInterval)
                    OptimizePerformance()
                end
            end)
        end
    end
})

local ClearMemoryButton = OptimizationTab:CreateButton({
    Name = "Clear Memory Now",
    Callback = function()
        ClearMemory()
    end
})

-- Anti-Ban Section
local AntiBanSection = OptimizationTab:CreateSection("Anti-Ban Settings")
local HumanLikeActionsToggle = OptimizationTab:CreateToggle({
    Name = "Human-like Actions",
    CurrentValue = AntiBan.HumanLikeActions,
    Flag = "HumanLikeActions",
    Callback = function(Value)
        AntiBan.HumanLikeActions = Value
    end
})

local RandomDelaysToggle = OptimizationTab:CreateToggle({
    Name = "Random Delays",
    CurrentValue = AntiBan.RandomDelays,
    Flag = "RandomDelays",
    Callback = function(Value)
        AntiBan.RandomDelays = Value
    end
})

local RandomMovementsToggle = OptimizationTab:CreateToggle({
    Name = "Random Movements",
    CurrentValue = AntiBan.RandomMovements,
    Flag = "RandomMovements",
    Callback = function(Value)
        AntiBan.RandomMovements = Value
    end
})

local MimicHumanBehaviorToggle = OptimizationTab:CreateToggle({
    Name = "Mimic Human Behavior",
    CurrentValue = AntiBan.MimicHumanBehavior,
    Flag = "MimicHumanBehavior",
    Callback = function(Value)
        AntiBan.MimicHumanBehavior = Value
        if Value then
            MimicHumanBehavior()
        end
    end
})

local AntiTeleportDetectionToggle = OptimizationTab:CreateToggle({
    Name = "Anti-Teleport Detection",
    CurrentValue = AntiBan.AntiTeleportDetection,
    Flag = "AntiTeleportDetection",
    Callback = function(Value)
        AntiBan.AntiTeleportDetection = Value
    end
})

local AntiSpeedHackDetectionToggle = OptimizationTab:CreateToggle({
    Name = "Anti-Speed Hack Detection",
    CurrentValue = AntiBan.AntiSpeedHackDetection,
    Flag = "AntiSpeedHackDetection",
    Callback = function(Value)
        AntiBan.AntiSpeedHackDetection = Value
    end
})

-- Statistics Section
local StatisticsSection = OptimizationTab:CreateSection("Statistics")
local StatsLabel1 = OptimizationTab:CreateLabel("Session: 00:00:00")
local StatsLabel2 = OptimizationTab:CreateLabel("Leviathan Killed: 0")
local StatsLabel3 = OptimizationTab:CreateLabel("Efficiency: 0.00/hr")
local StatsLabel4 = OptimizationTab:CreateLabel("Best Time: 0s")

local UpdateStatsButton = OptimizationTab:CreateButton({
    Name = "Update Statistics",
    Callback = function()
        local summary = GetStatisticsSummary()
        StatsLabel1:Set("Session: " .. summary.SessionDuration)
        StatsLabel2:Set("Leviathan Killed: " .. summary.LeviathanKilled)
        StatsLabel3:Set("Efficiency: " .. summary.Efficiency .. "/hr")
        StatsLabel4:Set("Best Time: " .. summary.BestTime)
    end
})

local SaveStatsButton = OptimizationTab:CreateButton({
    Name = "Save Statistics",
    Callback = function()
        SaveStatistics()
        SendNotification("Đã lưu thống kê!")
    end
})

local ResetStatsButton = OptimizationTab:CreateButton({
    Name = "Reset Statistics",
    Callback = function()
        Statistics = {
            SessionStart = tick(),
            LeviathanKilled = 0,
            TotalDamage = 0,
            TotalLoot = {},
            TimeSpent = 0,
            DeathCount = 0
        }
        InitializeStatistics()
        SendNotification("Đã reset thống kê!")
    end
})

-- Error Handling Section
local ErrorSection = OptimizationTab:CreateSection("Error Handling")
local AutoRestartToggle = OptimizationTab:CreateToggle({
    Name = "Auto Restart on Errors",
    CurrentValue = ErrorHandler.AutoRestart,
    Flag = "AutoRestart",
    Callback = function(Value)
        ErrorHandler.AutoRestart = Value
    end
})

local ViewErrorsButton = OptimizationTab:CreateButton({
    Name = "View Error Log",
    Callback = function()
        local errorCount = #ErrorHandler.ErrorLog
        if errorCount == 0 then
            SendNotification("Không có lỗi nào!")
        else
            local lastError = ErrorHandler.ErrorLog[errorCount]
            SendNotification("Lỗi gần nhất: " .. lastError.Message)
        end
    end
})

local ClearErrorsButton = OptimizationTab:CreateButton({
    Name = "Clear Error Log",
    Callback = function()
        ErrorHandler.ErrorLog = {}
        SendNotification("Đã xóa log lỗi!")
    end
})

-- ============================================
-- FINAL INTEGRATION & STARTUP
-- ============================================

-- Cập nhật thống kê liên tục
spawn(function()
    while true do
        wait(10)
        local summary = GetStatisticsSummary()
        StatsLabel1:Set("Session: " .. summary.SessionDuration)
        StatsLabel2:Set("Leviathan Killed: " .. summary.LeviathanKilled)
        StatsLabel3:Set("Efficiency: " .. summary.Efficiency .. "/hr")
        StatsLabel4:Set("Best Time: " .. summary.BestTime)
    end
end)

-- Auto tối ưu khi bắt đầu
if Config.AutoFPSBoost then
    OptimizePerformance()
end

-- Khởi động hệ thống
InitializeAntiBan()
InitializeStatistics()
InitializeWebhookTemplates()

-- Bắt đầu monitor
MonitorPerformance()

-- Thông báo hoàn thành
Rayfield:Notify({
    Title = "Astra X Hub - Leviathan",
    Content = "Start Scripts",
    Duration = 5,
    Image = nil
})

-- Auto bắt đầu nếu config được bật
if Config.AutoLeviathan then
    wait(3)
    EnhancedLeviathanFarmer()
    SendNotification("Start")
end

-- ============================================
-- CRITICAL FUNCTION WRAPPERS
-- ============================================

-- Wrap tất cả hàm quan trọng với error handling
FindLeviathan = CreateSafeWrapper(FindLeviathan)
AttackLeviathan = CreateSafeWrapper(AttackLeviathan)
SpawnLeviathan = CreateSafeWrapper(SpawnLeviathan)
CheckTide = CreateSafeWrapper(CheckTide)
EnterBoat = CreateSafeWrapper(EnterBoat)
UseCannon = CreateSafeWrapper(UseCannon)
CollectLeviathanLoot = CreateSafeWrapper(CollectLeviathanLoot)
OptimizePerformance = CreateSafeWrapper(OptimizePerformance)

-- Lưu ý: Script đã hoàn thiện với đầy đủ tính năng farm Leviathan
-- Tất cả hệ thống đã được tích hợp và tối ưu
